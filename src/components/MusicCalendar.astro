---
// src/components/MusicCalendar.astro
import type { CollectionEntry } from "astro:content";
import { getImage } from "astro:assets";
import { Icon } from "astro-icon/components";
import MusicCard from "./MusicCard.astro";

interface Props {
  title: string;
  dayNames: string[];
  firstDayOfWeek: number;
  daysInMonth: number;
  musicMap: Map<number, CollectionEntry<"music">>;
  todayDate: number;
  trailingCellsCount: number;
  prevMonthUrl: string | null;
  nextMonthUrl: string | null;
  year: number;
  month: number; // 1-based month
}
const {
  title,
  dayNames,
  firstDayOfWeek,
  daysInMonth,
  musicMap,
  todayDate,
  trailingCellsCount,
  prevMonthUrl,
  nextMonthUrl,
  year,
  month,
} = Astro.props;

const musicDays = Array.from(musicMap.keys()).sort((a, b) => a - b);
---

<div
  id="music-calendar-wrapper"
  data-year={year}
  data-month={month}
  class="max-w-4xl mx-auto py-12 relative"
>
  {/* --- 头部 --- */}
  <div
    class="flex justify-between items-end mb-12 border-b border-ink-900 dark:border-zinc-600 pb-4 transition-colors"
  >
    <h2
      class="text-4xl md:text-5xl font-serif font-bold text-ink-900 dark:text-zinc-100 leading-none transition-colors"
    >
      {title}
    </h2>

    <div class="flex gap-2">
      {
        prevMonthUrl ? (
          <a
            href={prevMonthUrl}
            aria-label="Previous"
            class="p-2 text-ink-500 dark:text-zinc-300 hover:text-vermilion transition-colors"
          >
            <Icon name="mingcute:arrow-left-line" class="w-6 h-6" />
          </a>
        ) : (
          <span class="p-2 text-ink-300 dark:text-zinc-700 cursor-not-allowed">
            <Icon name="mingcute:arrow-left-line" class="w-6 h-6" />
          </span>
        )
      }
      {
        nextMonthUrl ? (
          <a
            href={nextMonthUrl}
            aria-label="Next"
            class="p-2 text-ink-500 dark:text-zinc-300 hover:text-vermilion transition-colors"
          >
            <Icon name="mingcute:arrow-right-line" class="w-6 h-6" />
          </a>
        ) : (
          <span class="p-2 text-ink-300 dark:text-zinc-700 cursor-not-allowed">
            <Icon name="mingcute:arrow-right-line" class="w-6 h-6" />
          </span>
        )
      }
    </div>
  </div>

  {/* --- 星期表头 --- */}
  <div class="grid grid-cols-7 mb-4">
    {
      dayNames.map((day) => (
        <div class="text-center text-xs font-sans tracking-widest text-ink-500 dark:text-zinc-500 select-none transition-colors">
          {day}
        </div>
      ))
    }
  </div>

  {/* --- 日历网格 --- */}
  <div
    id="calendar-grid"
    class="grid grid-cols-7 border-t border-l border-ink-300/50 dark:border-zinc-700 transition-colors relative z-0"
  >
    {
      Array(firstDayOfWeek)
        .fill(null)
        .map(() => (
          <div class="aspect-square border-r border-b border-ink-300/50 dark:border-zinc-700 transition-colors" />
        ))
    }

    {
      Array(daysInMonth)
        .fill(null)
        .map(async (_, i) => {
          const day = i + 1;
          const post = musicMap.get(day);
          let optimizedImage = null;
          if (post) {
            optimizedImage = await getImage({
              src: post.data.coverImage,
              width: 200,
              height: 200,
              format: "webp",
            });
          }

          const isToday = day === todayDate;
          const cellIndex = firstDayOfWeek + i;
          const row = Math.floor(cellIndex / 7);
          const col = cellIndex % 7;

          // 弹窗位置逻辑
          const cardPositionClasses = [
            // 前2行向下弹，其余向上弹
            row < 2 ? "top-full mt-2" : "bottom-full mb-2",

            // 列逻辑：防止左右溢出
            col < 1
              ? "left-0 origin-left" // 最左侧：左对齐
              : col > 5
                ? "right-0 origin-right" // 最右侧：右对齐
                : "left-1/2 -translate-x-1/2 origin-center", // 中间：居中
          ];

          return (
            <div
              id={`music-cell-${day}`}
              data-day={day}
              class={`calendar-cell group relative aspect-square border-r border-b border-ink-300/50 dark:border-zinc-700 flex flex-col items-center justify-center transition-colors hover:bg-ink-300/10 dark:hover:bg-zinc-700/30 ${post ? "cursor-pointer" : ""}`}
            >
              <span class="day-number text-sm font-serif transition-colors z-10 pointer-events-none text-ink-700 dark:text-zinc-400 group-hover:text-ink-900 dark:group-hover:text-zinc-200">
                {day}
              </span>

              {post && optimizedImage ? (
                <>
                  {/* 圆点指示器 */}
                  <div class="indicator absolute w-8 h-8 md:w-12 md:h-12 rounded-full border border-ink-300/50 dark:border-zinc-600/50 transition-all pointer-events-none" />

                  <div
                    class={`music-popup absolute z-100 w-max transition-all duration-300 ease-out 
                              opacity-0 invisible pointer-events-none scale-95 
                              /* PC Hover 逻辑 */
                              lg:group-hover:opacity-100 lg:group-hover:visible lg:group-hover:pointer-events-auto lg:group-hover:scale-100
                              /* Mobile Active 逻辑 */
                              group-[.is-active]:opacity-100 group-[.is-active]:visible group-[.is-active]:pointer-events-auto group-[.is-active]:scale-100 
                              ${cardPositionClasses.join(" ")}`}
                  >
                    <MusicCard post={post} optimizedImage={optimizedImage} />
                  </div>
                </>
              ) : null}
            </div>
          );
        })
    }
    {
      Array(trailingCellsCount)
        .fill(null)
        .map(() => (
          <div class="aspect-square border-r border-b border-ink-300/50 dark:border-zinc-700 transition-colors" />
        ))
    }
  </div>

  {/* --- 移动端控制栏 --- */}
  {
    musicDays.length > 0 && (
      <div
        id="mobile-music-controls"
        class="lg:hidden mt-8 flex items-center justify-center gap-10 py-3 px-6 rounded-full bg-ink-300/10 dark:bg-zinc-300/10 border border-ink-200 dark:border-zinc-700 backdrop-blur-md mx-auto w-max relative z-100"
        data-days={JSON.stringify(musicDays)}
        data-today={todayDate}
      >
        <button
          id="btn-prev"
          class="text-ink-500 dark:text-zinc-300 hover:text-vermilion active:scale-90 active:text-vermilion transition-all cursor-pointer touch-manipulation disabled:opacity-30 disabled:cursor-not-allowed disabled:active:scale-100 disabled:hover:text-ink-500 dark:disabled:hover:text-zinc-400"
        >
          <Icon
            name="mingcute:skip-previous-line"
            class="w-6 h-6 pointer-events-none"
          />
        </button>

        <button
          id="btn-toggle"
          class="flex flex-col items-center gap-1 text-ink-800 dark:text-zinc-200 active:scale-90 transition-all cursor-pointer touch-manipulation"
        >
          <Icon
            name="mingcute:eye-close-line"
            id="icon-show"
            class="w-6 h-6 block pointer-events-none"
          />
          <Icon
            name="mingcute:eye-2-line"
            id="icon-hide"
            class="w-6 h-6 hidden text-vermilion pointer-events-none"
          />
        </button>

        <button
          id="btn-next"
          class="text-ink-500 dark:text-zinc-300 hover:text-vermilion active:scale-90 active:text-vermilion transition-all cursor-pointer touch-manipulation disabled:opacity-30 disabled:cursor-not-allowed disabled:active:scale-100 disabled:hover:text-ink-500 dark:disabled:hover:text-zinc-400"
        >
          <Icon
            name="mingcute:skip-forward-line"
            class="w-6 h-6 pointer-events-none"
          />
        </button>
      </div>
    )
  }
</div>

<style>
  .calendar-cell.is-active {
    z-index: 50;
  }

  .calendar-cell.is-active .music-popup {
    opacity: 1 !important;
    visibility: visible !important;
    pointer-events: auto !important;
  }

  .calendar-cell.is-active .indicator {
    border-color: rgba(var(--color-vermilion), 1);
    transform: scale(1.1);
  }

  @media (hover: hover) {
    .calendar-cell:hover {
      z-index: 50;
    }
    .calendar-cell:hover .music-popup {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }
    .calendar-cell:hover .indicator {
      border-color: rgba(var(--color-vermilion), 0.5);
    }
  }
</style>

<script>
  function highlightToday() {
    const wrapper = document.getElementById("music-calendar-wrapper");
    if (!wrapper) return;

    // 获取数据 (处理 undefined)
    const setYear = wrapper.dataset.year || "0";
    const setMonth = wrapper.dataset.month || "0";

    // 获取当前时间
    const now = new Date();
    const currentYear = String(now.getFullYear());
    const currentMonth = String(now.getMonth() + 1);
    const currentDate = now.getDate();

    // 只有“日历显示的年月”等于“现实世界的年月”时高亮
    if (setYear === currentYear && setMonth === currentMonth) {
      const selector = `.calendar-cell[data-day="${currentDate}"] .day-number`;
      const dateCellNumber = document.querySelector(selector);

      if (dateCellNumber) {
        // 移除原基础颜色 AND 悬停变色 (group-hover)
        dateCellNumber.classList.remove(
          "text-ink-700",
          "dark:text-zinc-400",
          "group-hover:text-ink-900",
          "dark:group-hover:text-zinc-200"
        );

        // 添加高亮样式 (朱红色 + 加粗 + 放大)
        dateCellNumber.classList.add(
          "text-vermilion",
          "font-bold",
          "scale-110"
        );
      }
    }
  }

  function initMobileControls() {
    highlightToday();
    const controls = document.getElementById("mobile-music-controls");
    if (!controls) return;

    const musicDays = JSON.parse(controls.dataset.days || "[]");
    const todayDate = parseInt(controls.dataset.today || "1");

    if (musicDays.length === 0) return;

    const btnPrev = document.getElementById("btn-prev") as HTMLButtonElement;
    const btnNext = document.getElementById("btn-next") as HTMLButtonElement;
    const btnToggle = document.getElementById("btn-toggle");
    const iconShow = document.getElementById("icon-show");
    const iconHide = document.getElementById("icon-hide");

    let isVisible = false;

    const findClosestIndex = () => {
      let foundIndex = -1;
      for (let i = 0; i < musicDays.length; i++) {
        if (musicDays[i] <= todayDate) {
          foundIndex = i;
        } else {
          break;
        }
      }
      return foundIndex === -1 ? 0 : foundIndex;
    };

    let currentIndex = findClosestIndex();

    const updateUI = () => {
      document.querySelectorAll(".calendar-cell.is-active").forEach((el) => {
        el.classList.remove("is-active");
      });

      if (isVisible) {
        const currentDay = musicDays[currentIndex];
        const targetCell = document.getElementById(`music-cell-${currentDay}`);
        if (targetCell) targetCell.classList.add("is-active");
        iconShow?.classList.add("hidden");
        iconHide?.classList.remove("hidden");
      } else {
        iconShow?.classList.remove("hidden");
        iconHide?.classList.add("hidden");
      }

      if (btnPrev) btnPrev.disabled = currentIndex === 0;
      if (btnNext) btnNext.disabled = currentIndex === musicDays.length - 1;
    };

    updateUI();

    btnToggle?.addEventListener("click", (e) => {
      e.stopPropagation();
      isVisible = !isVisible;
      updateUI();
    });

    btnPrev?.addEventListener("click", (e) => {
      e.stopPropagation();
      if (currentIndex > 0) {
        currentIndex--;
        isVisible = true;
        updateUI();
      }
    });

    btnNext?.addEventListener("click", (e) => {
      e.stopPropagation();
      if (currentIndex < musicDays.length - 1) {
        currentIndex++;
        isVisible = true;
        updateUI();
      }
    });

    const cells = document.querySelectorAll('[id^="music-cell-"]');
    cells.forEach((cell) => {
      cell.addEventListener("click", (e) => {
        if (window.matchMedia("(hover: none)").matches) {
          e.stopPropagation();
          const day = parseInt(cell.id.replace("music-cell-", ""));
          const index = musicDays.indexOf(day);
          if (index !== -1) {
            currentIndex = index;
            isVisible = !cell.classList.contains("is-active");
            updateUI();
          }
        }
      });
    });

    document.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      if (
        !controls.contains(target) &&
        !target.closest(".music-card-content") &&
        !target.closest('[id^="music-cell-"]')
      ) {
        if (isVisible) {
          isVisible = false;
          updateUI();
        }
      }
    });
  }

  document.addEventListener("astro:page-load", initMobileControls);
  document.addEventListener("DOMContentLoaded", initMobileControls);
</script>
