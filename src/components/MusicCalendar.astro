---
// src/components/MusicCalendar.astro
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon/components';

// 1. è·å–æ‰€æœ‰éŸ³ä¹æ•°æ®
const allMusic = await getCollection('music');

// 2. å°†æ•°æ®å¤„ç†ä¸ºå®¢æˆ·ç«¯è„šæœ¬æ˜“äºä½¿ç”¨çš„æ ¼å¼
// é”®ä¸º 'YYYY-MM-DD'ï¼Œå€¼ä¸ºæ­Œæ›²ä¿¡æ¯
const musicMap: Record<string, { title: string; artist: string; coverSrc: string }> = {};

for (const post of allMusic) {
  // ç¡®ä¿æ—¥æœŸæ˜¯æ ‡å‡†åŒ–çš„ YYYY-MM-DD æ ¼å¼ï¼Œä¸å—æ—¶åŒºå½±å“
  const y = post.data.pubDate.getFullYear();
  const m = String(post.data.pubDate.getMonth() + 1).padStart(2, '0');
  const d = String(post.data.pubDate.getDate()).padStart(2, '0');
  const dateKey = `${y}-${m}-${d}`;
  
  musicMap[dateKey] = {
    title: post.data.title,
    artist: post.data.artist,
    // coverImage.src æ˜¯ç”± Astro å¤„ç†è¿‡çš„ä¼˜åŒ–åçš„å›¾ç‰‡è·¯å¾„
    coverSrc: post.data.coverImage.src,
  };
}

// ä»Šå¤©çš„æ—¥æœŸï¼Œç”¨äºé«˜äº®
const todayKey = new Date().toISOString().split('T')[0];
---
<div class="calendar-container">
  
  <div class="calendar-header">
    <button id="cal-prev" aria-label="ä¸Šä¸ªæœˆ">
      <Icon name="mingcute:left-fill" class="w-5 h-5" />
    </button>
    <h3 id="cal-month-year" class="text-xl font-bold"></h3>
    <button id="cal-next" aria-label="ä¸‹ä¸ªæœˆ">
      <Icon name="mingcute:right-fill" class="w-5 h-5" />
    </button>
  </div>

  <div class="calendar-days-header">
    <div>æ—¥</div>
    <div>ä¸€</div>
    <div>äºŒ</div>
    <div>ä¸‰</div>
    <div>å››</div>
    <div>äº”</div>
    <div>å…­</div>
  </div>

  <div id="cal-grid" class="calendar-grid">
    </div>

</div>

<div id="music-tooltip" class="music-tooltip" role="tooltip">
  <img id="tooltip-img" src="" alt="Album cover" />
  <div class="tooltip-content">
    <h4 id="tooltip-title">Song Title</h4>
    <p id="tooltip-artist">Artist</p>
  </div>
</div>

<script id="music-data" type="application/json">
  {JSON.stringify(musicMap)}
</script>

<style>
  .calendar-container {
    max-width: 900px;
    margin: 0 auto;
    background: var(--astro-colors-zinc-800); /* æ·±è‰²èƒŒæ™¯ */
    padding: 1.5rem;
    border-radius: 0.5rem;
    box-shadow: var(--box-shadow);
  }

  .calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    color: var(--astro-colors-zinc-100);
  }
  .calendar-header button {
    background: var(--astro-colors-zinc-700);
    border: none;
    border-radius: 0.375rem;
    padding: 0.5rem;
    cursor: pointer;
    transition: background-color 0.2s;
  }
  .calendar-header button:hover {
    background: var(--astro-colors-zinc-600);
  }

  .calendar-days-header {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    text-align: center;
    color: var(--astro-colors-zinc-400);
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 4px;
  }

  .calendar-day {
    position: relative;
    aspect-ratio: 1 / 1; /* ä¿æŒæ–¹å— */
    background: var(--astro-colors-zinc-900);
    border-radius: 0.25rem;
    padding: 0.5rem;
    color: var(--astro-colors-zinc-300);
    font-size: 0.875rem;
  }

  .calendar-day.other-month {
    color: var(--astro-colors-zinc-600);
    background: var(--astro-colors-zinc-800);
  }
  
  .calendar-day.is-today {
    /* é«˜äº®ä»Šå¤© */
    background: var(--astro-colors-blue-900);
    font-weight: bold;
    color: var(--astro-colors-blue-200);
  }

  .calendar-day span {
    display: block;
    text-align: left;
  }
  
  .calendar-day .music-icon {
    position: absolute;
    bottom: 0.5rem;
    right: 0.5rem;
    font-size: 1.5rem;
    cursor: help; /* æç¤ºå¯æ‚¬åœ */
    transition: transform 0.2s;
  }
  
  .calendar-day.has-music:hover .music-icon {
    transform: scale(1.2);
  }

  /* æµ®çª—æ ·å¼ */
  .music-tooltip {
    position: fixed; /* ä½¿ç”¨ fixed å®šä½ */
    left: 0;
    top: 0;
    z-index: 50;
    background: var(--astro-colors-zinc-800);
    color: white;
    border-radius: 0.5rem;
    box-shadow: 0 10px 15px rgba(0,0,0,0.4);
    display: flex;
    width: 280px;
    overflow: hidden;
    
    /* é»˜è®¤éšè—ï¼Œç”± JS æ§åˆ¶ */
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition: opacity 0.2s, transform 0.2s;
    transform: scale(0.95);
  }
  
  .music-tooltip.is-visible {
    opacity: 1;
    visibility: visible;
    transform: scale(1);
  }
  
  .music-tooltip img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .tooltip-content {
    padding: 0.75rem 1rem;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }
  .tooltip-content h4 {
    font-size: 1rem;
    font-weight: 600;
    line-height: 1.2;
    margin: 0 0 0.25rem 0;
  }
  .tooltip-content p {
    font-size: 0.875rem;
    color: var(--astro-colors-zinc-400);
    margin: 0;
  }
</style>

<script define:vars={{ todayKey }}>
  function initMusicCalendar() {
    // 1. è·å–æ•°æ®å’Œ DOM å…ƒç´ 
    const musicDataEl = document.getElementById('music-data');
    const musicData = JSON.parse(musicDataEl.textContent);
    
    const prevBtn = document.getElementById('cal-prev');
    const nextBtn = document.getElementById('cal-next');
    const monthYearEl = document.getElementById('cal-month-year');
    const gridEl = document.getElementById('cal-grid');
    
    const tooltip = document.getElementById('music-tooltip');
    const tooltipImg = document.getElementById('tooltip-img');
    const tooltipTitle = document.getElementById('tooltip-title');
    const tooltipArtist = document.getElementById('tooltip-artist');

    // æ£€æŸ¥æ˜¯å¦å·²åˆå§‹åŒ–ï¼Œé˜²æ­¢ astro:page-load é‡å¤æ‰§è¡Œ
    if (gridEl.dataset.initialized === 'true') {
      return;
    }
    gridEl.dataset.initialized = 'true';

    // é»˜è®¤æ˜¾ç¤ºä»Šå¤©çš„æ—¥æœŸæ‰€åœ¨çš„æœˆä»½
    // æ³¨æ„ï¼šJS çš„ Date() æœˆä»½æ˜¯ä» 0 å¼€å§‹çš„
    let currentDate = new Date();

    function renderCalendar(date) {
      gridEl.innerHTML = ''; // æ¸…ç©ºç½‘æ ¼
      
      const year = date.getFullYear();
      const month = date.getMonth(); // 0-11
      
      // æ›´æ–°å¤´éƒ¨
      monthYearEl.textContent = `${year}å¹´ ${month + 1}æœˆ`;
      
      // è®¡ç®—å½“æœˆçš„ç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡  (0=å‘¨æ—¥, 1=å‘¨ä¸€...)
      const firstDayOfMonth = new Date(year, month, 1).getDay();
      // è®¡ç®—å½“æœˆçš„æ€»å¤©æ•°
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      // 1. å¡«å……ä¸Šä¸ªæœˆçš„å°¾å·´ (ç©ºç™½æ ¼å­)
      for (let i = 0; i < firstDayOfMonth; i++) {
        const dayEl = document.createElement('div');
        dayEl.classList.add('calendar-day', 'other-month');
        gridEl.appendChild(dayEl);
      }
      
      // 2. å¡«å……å½“æœˆçš„æ‰€æœ‰å¤©
      for (let day = 1; day <= daysInMonth; day++) {
        const dayEl = document.createElement('div');
        dayEl.classList.add('calendar-day');
        
        const dayKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        // é«˜äº®ä»Šå¤©
        if (dayKey === todayKey) {
          dayEl.classList.add('is-today');
        }
        
        // æ£€æŸ¥è¿™ä¸€å¤©æ˜¯å¦æœ‰éŸ³ä¹
        const song = musicData[dayKey];
        if (song) {
          dayEl.classList.add('has-music');
          dayEl.dataset.date = dayKey; // å­˜å‚¨æ—¥æœŸé”®
          dayEl.innerHTML = `<span>${day}</span><div class="music-icon">ğŸ§</div>`;
        } else {
          dayEl.innerHTML = `<span>${day}</span>`;
        }
        
        gridEl.appendChild(dayEl);
      }
    }
    
    // 3. äº‹ä»¶ç›‘å¬
    
    // æœˆä»½åˆ‡æ¢
    prevBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() - 1);
      renderCalendar(currentDate);
    });
    
    nextBtn.addEventListener('click', () => {
      currentDate.setMonth(currentDate.getMonth() + 1);
      renderCalendar(currentDate);
    });
    
    // æµ®çª—é€»è¾‘ (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
    gridEl.addEventListener('mouseover', (e) => {
      const musicDay = e.target.closest('.has-music');
      if (!musicDay) return;
      
      const song = musicData[musicDay.dataset.date];
      if (!song) return;
      
      // å¡«å……æµ®çª—å†…å®¹
      tooltipImg.src = song.coverSrc;
      tooltipTitle.textContent = song.title;
      tooltipArtist.textContent = song.artist;
      
      // å®šä½æµ®çª— (åœ¨é¼ æ ‡æŒ‡é’ˆå³ä¸‹æ–¹)
      const offset = 10;
      tooltip.style.left = `${e.pageX + offset}px`;
      tooltip.style.top = `${e.pageY + offset}px`;
      
      tooltip.classList.add('is-visible');
    });
    
    gridEl.addEventListener('mouseout', (e) => {
      if (e.target.closest('.has-music')) {
        tooltip.classList.remove('is-visible');
      }
    });

    // æ‚¨çš„éœ€æ±‚ï¼šç‚¹å‡»åæ’­æ”¾ï¼ˆå…ˆä¸å®ç°åŠŸèƒ½ï¼‰
    gridEl.addEventListener('click', (e) => {
      const musicDay = e.target.closest('.has-music');
      if (!musicDay) return;
      
      const song = musicData[musicDay.dataset.date];
      console.log(`[æ’­æ”¾é€»è¾‘] å‡†å¤‡æ’­æ”¾: ${song.title} - ${song.artist}`);
      // (æ­¤å¤„æœªæ¥å¯ä»¥å®ç°æ’­æ”¾å™¨é€»è¾‘)
      alert(`å‡†å¤‡æ’­æ”¾: ${song.title}\n(æ’­æ”¾åŠŸèƒ½å¾…å®ç°)`);
    });
    
    // 4. åˆå§‹æ¸²æŸ“
    renderCalendar(currentDate);
  }

  // Astro é¡µé¢ç”Ÿå‘½å‘¨æœŸ
  document.addEventListener('DOMContentLoaded', initMusicCalendar);
  document.addEventListener('astro:page-load', initMusicCalendar);
</script>