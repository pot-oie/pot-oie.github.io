---
// src/components/MusicCalendar.astro
import type { MusicData } from "../data/music.ts";
import { getImage } from "astro:assets";
import { Icon } from "astro-icon/components";
import MusicCard from "./MusicCard.astro";

interface Props {
  currentMonthKey: string;
  musicData: MusicData[];
  prevMonthUrl: string | null;
  nextMonthUrl: string | null;
}
const { currentMonthKey, musicData, prevMonthUrl, nextMonthUrl } = Astro.props;

const [yearStr, monthStr] = currentMonthKey.split("-");
const year = 2000 + parseInt(yearStr);
const month = parseInt(monthStr) - 1;
const title = new Date(year, month, 1).toLocaleString("zh-CN", {
  year: "numeric",
  month: "long",
});
const firstDayOfWeek = new Date(year, month, 1).getDay();
const daysInMonth = new Date(year, month + 1, 0).getDate();
const totalCellsNeeded = firstDayOfWeek + daysInMonth;
const totalGridCells = Math.ceil(totalCellsNeeded / 7) * 7;
const trailingCellsCount = totalGridCells - totalCellsNeeded;
const musicMap = new Map<number, MusicData>();
for (const post of musicData) {
  musicMap.set(post.pubDate.getDate(), post);
}

const today = new Date();
const todayKey = `${today.getFullYear().toString().slice(-2)}-${String(today.getMonth() + 1).padStart(2, "0")}`;
const todayDate = currentMonthKey === todayKey ? today.getDate() : -1;
const dayNames = ["SUN", "MON", "TUE", "WED", "THU", "FRI", "SAT"];
---

<div class="max-w-4xl mx-auto py-12">
  {/* --- 头部 --- */}
  <div
    class="flex justify-between items-end mb-12 border-b border-ink-900 dark:border-zinc-600 pb-4 transition-colors"
  >
    <h2
      class="text-4xl md:text-5xl font-serif font-bold text-ink-900 dark:text-zinc-100 leading-none transition-colors"
    >
      {title}
    </h2>

    <div class="flex gap-2">
      {
        prevMonthUrl ? (
          <a
            href={prevMonthUrl}
            aria-label="Previous"
            class="p-2 text-ink-500 dark:text-zinc-300 hover:text-vermilion dark:hover:text-vermilion transition-colors"
          >
            <Icon name="mingcute:arrow-left-line" class="w-6 h-6" />
          </a>
        ) : (
          <span class="p-2 text-ink-300 dark:text-zinc-700 cursor-not-allowed transition-colors">
            <Icon name="mingcute:arrow-left-line" class="w-6 h-6" />
          </span>
        )
      }
      {
        nextMonthUrl ? (
          <a
            href={nextMonthUrl}
            aria-label="Next"
            class="p-2 text-ink-500 dark:text-zinc-300 hover:text-vermilion dark:hover:text-vermilion transition-colors"
          >
            <Icon name="mingcute:arrow-right-line" class="w-6 h-6" />
          </a>
        ) : (
          <span class="p-2 text-ink-300 dark:text-zinc-700 cursor-not-allowed transition-colors">
            <Icon name="mingcute:arrow-right-line" class="w-6 h-6" />
          </span>
        )
      }
    </div>
  </div>

  {/* --- 星期表头 --- */}
  <div class="grid grid-cols-7 mb-4">
    {
      dayNames.map((day) => (
        <div class="text-center text-xs font-sans tracking-widest text-ink-500 dark:text-zinc-500 select-none transition-colors">
          {day}
        </div>
      ))
    }
  </div>

  {/* --- 日历网格 --- */}
  <div
    class="grid grid-cols-7 border-t border-l border-ink-300/50 dark:border-zinc-700 transition-colors"
  >
    {/* 头部空白 */}
    {
      Array(firstDayOfWeek)
        .fill(null)
        .map(() => (
          <div class="aspect-square border-r border-b border-ink-300/50 dark:border-zinc-700 transition-colors" />
        ))
    }

    {/* 日期单元格 */}
    {
      Array(daysInMonth)
        .fill(null)
        .map(async (_, i) => {
          const day = i + 1;
          const post = musicMap.get(day);
          let optimizedImage = null;
          if (post) {
            optimizedImage = await getImage({
              src: post.coverImage,
              width: 200,
              height: 200,
              format: "webp",
            });
          }

          const isToday = day === todayDate;
          const cellIndex = firstDayOfWeek + i;
          const row = Math.floor(cellIndex / 7);
          const col = cellIndex % 7;
          const cardPositionClasses = [
            row < 3 ? "top-full mt-2" : "bottom-full mb-2",
            col < 1
              ? "left-0"
              : col > 5
                ? "right-0"
                : "left-1/2 -translate-x-1/2",
          ];

          return (
            <div class="group relative aspect-square border-r border-b border-ink-300/50 dark:border-zinc-700 flex flex-col items-center justify-center transition-colors hover:bg-ink-300/10 dark:hover:bg-zinc-700/30">
              {/* 日期数字 */}
              <span
                class:list={[
                  "text-sm font-serif transition-colors z-10 pointer-events-none",
                  isToday
                    ? "text-vermilion font-bold scale-110"
                    : "text-ink-700 dark:text-zinc-400 group-hover:text-ink-900 dark:group-hover:text-zinc-200",
                ]}
              >
                {day}
              </span>

              {post && optimizedImage ? (
                <>
                  {/* 背景圆点指示器 */}
                  <div class="absolute w-8 h-8 md:w-12 md:h-12 rounded-full border border-ink-300/50 dark:border-zinc-600/50 group-hover:border-vermilion/50 transition-colors" />

                  <div class="absolute inset-0 cursor-pointer z-0" />

                  <MusicCard
                    post={post}
                    optimizedImage={optimizedImage}
                    positionClasses={cardPositionClasses}
                  />
                </>
              ) : null}
            </div>
          );
        })
    }

    {/* 尾部空白 */}
    {
      Array(trailingCellsCount)
        .fill(null)
        .map(() => (
          <div class="aspect-square border-r border-b border-ink-300/50 dark:border-zinc-700 transition-colors" />
        ))
    }
  </div>
</div>
