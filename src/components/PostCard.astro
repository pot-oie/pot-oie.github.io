---
// src/components/PostCard.astro
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import FormattedDate from "./FormattedDate.astro";
import type { CollectionEntry } from "astro:content";

interface Props {
  post: CollectionEntry<"blog">;
}

const { post } = Astro.props;
const slug = post.id.replace(/\.mdx?$/, "");

// 日期显示逻辑
const isUpdated = !!post.data.updatedDate;
const displayDate = post.data.updatedDate ?? post.data.pubDate;
---

<a
  href={`/blog/${slug}/`}
  class="post-card-link group relative block py-12 border-t border-ink-300/30 first:border-t-0
         transition-all duration-500
         hover:pl-4
         active:pl-4 active:duration-200
         group-[.is-active]:pl-4 group-[.is-active]:duration-200"
>
  {/* 悬停/点击时的背景图 (Ghost Image) */}
  {
    post.data.coverImage && (
      <div
        class="absolute right-0 top-1/2 -translate-y-1/2 h-[120%] w-2/3 md:w-1/2 opacity-0 
                  group-hover:opacity-15 
                  group-active:opacity-15 group-active:duration-300
                  group-[.is-active]:opacity-15 group-[.is-active]:duration-300
                  transition-opacity duration-700 ease-out pointer-events-none mix-blend-multiply dark:mix-blend-overlay grayscale blur-[1px] overflow-hidden select-none z-0"
      >
        <Image
          src={post.data.coverImage}
          alt=""
          width={600}
          quality={80}
          format="webp"
          loading="eager"
          class="w-full h-full object-cover mask-image-gradient"
        />
      </div>
    )
  }

  {/* 内容区域 */}
  <div
    class="relative z-10 flex flex-col md:flex-row gap-4 md:items-baseline md:justify-between"
  >
    <h3
      class="text-3xl md:text-4xl font-serif font-bold text-ink-900 dark:text-zinc-100
             group-hover:text-vermilion dark:group-hover:text-vermilion
             group-active:text-vermilion dark:group-active:text-vermilion
             group-[.is-active]:text-vermilion dark:group-[.is-active]:text-vermilion
             transition-colors duration-300 active:duration-150 group-[.is-active]:duration-150"
    >
      {post.data.shortTitle || post.data.title}
    </h3>

    {/* 日期 */}
    <div
      class="shrink-0 font-sans text-sm font-medium tracking-widest uppercase transition-colors flex items-center gap-2
      text-ink-300
      group-hover:text-ink-500 group-active:text-ink-500 group-[.is-active]:text-ink-500
      dark:text-zinc-500 dark:group-hover:text-zinc-300 dark:group-active:text-zinc-300 dark:group-[.is-active]:text-zinc-300"
    >
      {
        isUpdated && (
          <div
            class="flex items-center gap-1 transition-colors duration-300
                   text-vermilion
                   group-hover:text-vermilion-hover"
          >
            <Icon
              name="mingcute:refresh-2-line"
              class="w-4 h-4 transition-transform duration-500 ease-in-out group-hover:rotate-180"
            />

            <span class="font-bold text-xs">Updated</span>
          </div>
        )
      }
      <FormattedDate date={displayDate} />
    </div>
  </div>

  {/* 摘要 */}
  <p
    class="relative z-10 mt-4 max-w-2xl text-lg leading-relaxed line-clamp-2 transition-colors duration-300
    text-ink-500
    group-hover:text-ink-700 group-active:text-ink-700 group-[.is-active]:text-ink-700
    dark:text-zinc-400 dark:group-hover:text-zinc-200 dark:group-active:text-zinc-200 dark:group-[.is-active]:text-zinc-200"
  >
    {post.data.description}
  </p>

  {/* 装饰性箭头 */}
  <div
    class="relative z-10 mt-6 opacity-0 -translate-x-2
           group-hover:opacity-100 group-hover:translate-x-0
           group-active:opacity-100 group-active:translate-x-0 group-active:duration-200
           group-[.is-active]:opacity-100 group-[.is-active]:translate-x-0 group-[.is-active]:duration-200
           transition-all duration-300 text-vermilion"
  >
    <span class="text-sm font-bold tracking-widest">READ MORE &rarr;</span>
  </div>
</a>

<style>
  .mask-image-gradient {
    -webkit-mask-image: linear-gradient(to right, transparent, black 40%);
    mask-image: linear-gradient(to right, transparent, black 40%);
  }
</style>

<script>
  // 查找页面上所有的卡片链接
  const cards = document.querySelectorAll(".post-card-link");

  cards.forEach((card) => {
    card.addEventListener("click", (e) => {
      const mouseEvent = e as MouseEvent;
      const target = e.currentTarget as HTMLAnchorElement;

      if (
        mouseEvent.metaKey ||
        mouseEvent.ctrlKey ||
        target.classList.contains("is-active")
      )
        return;

      // 阻止默认的立即跳转
      e.preventDefault();

      // 添加 'is-active' 类，强制固定住所有的 active 样式
      target.classList.add("is-active");

      // 延迟 400ms 后再跳转
      setTimeout(() => {
        window.location.href = target.href;
      }, 400);
    });
  });
</script>
