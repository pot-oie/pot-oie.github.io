---
// src/components/MovieScroll.astro
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import type { CollectionEntry } from "astro:content";

export interface Props {
  posts: CollectionEntry<"movie">[];
}

const { posts } = Astro.props;
---

<div class="relative w-full group/scroll">
  {/* 左右边缘遮罩 */}
  <div
    class="absolute left-0 top-0 bottom-0 w-8 md:w-16 bg-linear-to-r from-[#f2f2f2] dark:from-[#18181b] to-transparent z-20 pointer-events-none transition-colors duration-300"
  >
  </div>
  <div
    class="absolute right-0 top-0 bottom-0 w-8 md:w-16 bg-linear-to-l from-[#f2f2f2] dark:from-[#18181b] to-transparent z-20 pointer-events-none transition-colors duration-300"
  >
  </div>

  {/* 滚动容器 */}
  <div
    class="movie-scroll-container flex overflow-x-auto gap-4 md:gap-6 pb-8 pt-4 px-4 md:px-8 snap-x snap-mandatory scrollbar-hide items-center cursor-grab active:cursor-grabbing"
    style="scrollbar-width: none; -ms-overflow-style: none;"
    data-lenis-prevent
  >
    {
      posts.map((post) => {
        const slug = post.id.replace(/\.mdx?$/, "");
        return (
          <a
            href={`/movie/${slug}/`}
            class="scroll-card-link relative shrink-0 snap-center w-40 md:w-[200px] aspect-2/3 group/card transition-all duration-500 ease-out active:scale-95 md:hover:scale-105 md:hover:-translate-y-2 z-0 md:hover:z-10 select-none"
            draggable="false"
          >
            {/* 图片容器 */}
            <div class="w-full h-full overflow-hidden rounded-sm shadow-ink relative">
              <Image
                src={post.data.coverImage}
                alt={post.data.title}
                width={600}
                loading="eager"
                transition:name={`movie-${slug}`}
                class="w-full h-full object-cover filter grayscale contrast-[1.1] transition-all duration-700 pointer-events-none md:group-hover/card:grayscale-0 md:group-hover/card:contrast-100 group-[.is-active]/card:grayscale-0 group-[.is-active]/card:contrast-100 active:grayscale-0 active:contrast-100"
                draggable="false"
              />

              {/* 评分印章 */}
              <div class="absolute top-2 right-2 bg-ink-100/90 backdrop-blur-sm px-2 py-0.5 rounded-sm shadow-sm translate-y-2 transition-all duration-300 flex items-center gap-1 opacity-0 md:group-hover/card:opacity-100 md:group-hover/card:translate-y-0 group-[.is-active]/card:opacity-100 group-[.is-active]/card:translate-y-0">
                <Icon
                  name="mingcute:star-fill"
                  class="w-3 h-3 text-vermilion"
                />
                <span class="text-xs font-serif font-bold text-ink-900">
                  {post.data.rating.toFixed(1)}
                </span>
              </div>

              {/* 底部渐变标题 */}
              <div class="absolute bottom-0 left-0 right-0 p-3 bg-linear-to-t from-ink-900/80 to-transparent flex items-end transition-opacity duration-300 opacity-0 md:group-hover/card:opacity-100 group-[.is-active]/card:opacity-100">
                <h4 class="text-ink-100 font-serif text-sm font-bold leading-tight line-clamp-2 shadow-black drop-shadow-md">
                  {post.data.title}
                </h4>
              </div>
            </div>
          </a>
        );
      })
    }

    {/* 末尾占位 */}
    <div class="shrink-0 w-4 md:w-8"></div>
  </div>

  {/* 底部提示 */}
  <div
    class="text-center mt-2 opacity-0 group-hover/scroll:opacity-60 transition-opacity duration-500"
  >
    <span
      class="text-xs font-sans tracking-widest text-ink-300 dark:text-zinc-500 uppercase"
      >Scroll Horizontally / 移动端体验更佳</span
    >
  </div>
</div>

<style>
  /* 隐藏滚动条但保留功能 */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>

<script>
  const scrollContainer = document.querySelector(
    ".movie-scroll-container"
  ) as HTMLElement;

  if (scrollContainer) {
    // 1. 滚轮映射
    scrollContainer.addEventListener(
      "wheel",
      (evt) => {
        const e = evt as WheelEvent;
        if (scrollContainer.scrollWidth > scrollContainer.clientWidth) {
          if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
            e.preventDefault();
            scrollContainer.scrollLeft += e.deltaY;
          }
        }
      },
      { passive: false }
    );

    // 2. 鼠标拖拽滚动逻辑 + 点击冲突处理
    let isDown = false;
    let startX = 0;
    let scrollLeft = 0;
    let hasMoved = false;

    scrollContainer.addEventListener("mousedown", (e) => {
      isDown = true;
      hasMoved = false;
      scrollContainer.classList.add("cursor-grabbing");
      startX = e.pageX - scrollContainer.offsetLeft;
      scrollLeft = scrollContainer.scrollLeft;
    });

    const stopDragging = () => {
      isDown = false;
      scrollContainer.classList.remove("cursor-grabbing");
    };

    scrollContainer.addEventListener("mouseleave", stopDragging);
    scrollContainer.addEventListener("mouseup", stopDragging);

    scrollContainer.addEventListener("mousemove", (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - scrollContainer.offsetLeft;
      const walk = (x - startX) * 1.5;

      if (Math.abs(walk) > 5) {
        hasMoved = true;
      }

      scrollContainer.scrollLeft = scrollLeft - walk;
    });

    // 3. 链接点击拦截逻辑
    const links = scrollContainer.querySelectorAll(".scroll-card-link");
    links.forEach((link) => {
      link.addEventListener("click", (e) => {
        const target = e.currentTarget as HTMLAnchorElement;
        const mouseEvent = e as MouseEvent;

        if (hasMoved) {
          e.preventDefault();
          e.stopPropagation();
          return;
        }

        if (
          mouseEvent.metaKey ||
          mouseEvent.ctrlKey ||
          target.classList.contains("is-active")
        )
          return;

        e.preventDefault();
        target.classList.add("is-active");

        setTimeout(() => {
          window.location.href = target.href;
        }, 400);
      });
    });
  }
</script>
