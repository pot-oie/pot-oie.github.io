---
// src/components/MovieScroll.astro
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import type { CollectionEntry } from "astro:content";

export interface Props {
  posts: CollectionEntry<"movie">[];
}

const { posts } = Astro.props;
---

{/* 外部容器：控制遮罩和内边距 */}
<div class="relative w-full group/scroll">
  {/* 左右边缘的淡出遮罩 - 适配暗色模式 */}
  <div
    class="absolute left-0 top-0 bottom-0 w-8 md:w-16 bg-linear-to-r from-[#f2f2f2] dark:from-[#18181b] to-transparent z-20 pointer-events-none transition-colors duration-300"
  >
  </div>
  <div
    class="absolute right-0 top-0 bottom-0 w-8 md:w-16 bg-linear-to-l from-[#f2f2f2] dark:from-[#18181b] to-transparent z-20 pointer-events-none transition-colors duration-300"
  >
  </div>

  {/* 滚动容器 */}
  <div
    class="movie-scroll-container flex overflow-x-auto gap-4 md:gap-6 pb-8 pt-4 px-4 md:px-8 snap-x snap-mandatory scrollbar-hide items-center cursor-grab active:cursor-grabbing"
    style="scrollbar-width: none; -ms-overflow-style: none;"
    data-lenis-prevent
  >
    {
      posts.map((post) => (
        <a
          href={`/movie/${post.id.replace(/\.mdx?$/, "")}/`}
          class="relative shrink-0 snap-center w-40 md:w-[200px] aspect-2/3 group/card transition-all duration-500 ease-out hover:scale-105 hover:-translate-y-2 z-0 hover:z-10 select-none"
          draggable="false"
        >
          {/* ^^^ 关键：draggable="false" 防止链接拖拽干扰滚动 */}

          {/* 图片容器 */}
          <div class="w-full h-full overflow-hidden rounded-sm shadow-ink relative">
            <Image
              src={post.data.coverImage}
              alt={post.data.title}
              width={400}
              class="w-full h-full object-cover filter grayscale contrast-[1.1] transition-all duration-700 group-hover/card:grayscale-0 group-hover/card:contrast-100 pointer-events-none"
              draggable="false"
            />
            {/* ^^^ 关键：pointer-events-none 和 draggable="false" 确保鼠标事件穿透给容器处理拖拽 */}

            {/* 评分印章 (悬停显示) */}
            <div class="absolute top-2 right-2 bg-ink-100/90 backdrop-blur-sm px-2 py-0.5 rounded-sm shadow-sm opacity-0 group-hover/card:opacity-100 translate-y-2 group-hover/card:translate-y-0 transition-all duration-300 flex items-center gap-1">
              <Icon name="mingcute:star-fill" class="w-3 h-3 text-vermilion" />
              <span class="text-xs font-serif font-bold text-ink-900">
                {post.data.rating.toFixed(1)}
              </span>
            </div>

            {/* 底部渐变标题 (悬停显示) */}
            <div class="absolute bottom-0 left-0 right-0 p-3 bg-linear-to-t from-ink-900/80 to-transparent opacity-0 group-hover/card:opacity-100 transition-opacity duration-300 flex items-end">
              <h4 class="text-ink-100 font-serif text-sm font-bold leading-tight line-clamp-2 shadow-black drop-shadow-md">
                {post.data.title}
              </h4>
            </div>
          </div>
        </a>
      ))
    }

    {/* 末尾占位 */}
    <div class="shrink-0 w-4 md:w-8"></div>
  </div>

  {/* 底部提示 */}
  <div
    class="text-center mt-2 opacity-0 group-hover/scroll:opacity-60 transition-opacity duration-500"
  >
    <span
      class="text-xs font-sans tracking-widest text-ink-300 dark:text-zinc-500 uppercase"
      >Scroll Horizontally / 移动端体验更佳</span
    >
  </div>
</div>

<style>
  /* 隐藏滚动条但保留功能 */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>

<script>
  const scrollContainer = document.querySelector(
    ".movie-scroll-container"
  ) as HTMLElement;

  if (scrollContainer) {
    // 1. 滚轮映射 (保持不变)
    scrollContainer.addEventListener(
      "wheel",
      (evt) => {
        const e = evt as WheelEvent;
        if (scrollContainer.scrollWidth > scrollContainer.clientWidth) {
          if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
            e.preventDefault();
            scrollContainer.scrollLeft += e.deltaY;
          }
        }
      },
      { passive: false }
    );

    // 2. 鼠标拖拽滚动逻辑
    let isDown = false;
    let startX = 0;
    let scrollLeft = 0;

    scrollContainer.addEventListener("mousedown", (e) => {
      isDown = true;
      scrollContainer.classList.add("cursor-grabbing");
      // 记录初始点击位置
      startX = e.pageX - scrollContainer.offsetLeft;
      scrollLeft = scrollContainer.scrollLeft;
    });

    const stopDragging = () => {
      isDown = false;
      scrollContainer.classList.remove("cursor-grabbing");
    };

    scrollContainer.addEventListener("mouseleave", stopDragging);
    scrollContainer.addEventListener("mouseup", stopDragging);

    scrollContainer.addEventListener("mousemove", (e) => {
      if (!isDown) return;
      e.preventDefault();
      const x = e.pageX - scrollContainer.offsetLeft;
      // 这里的 1.5 是速度系数，可以根据手感微调
      const walk = (x - startX) * 1.5;
      scrollContainer.scrollLeft = scrollLeft - walk;
    });
  }
</script>
