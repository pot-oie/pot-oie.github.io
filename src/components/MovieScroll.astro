---
// src/components/MovieScroll.astro
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import type { CollectionEntry } from "astro:content";

export interface Props {
  posts: CollectionEntry<"movie">[];
}

const { posts } = Astro.props;
---

{/* 外部容器：控制遮罩和内边距 */}
<div class="relative w-full group/scroll">
  {/* 左右边缘的淡出遮罩，增加“长卷”的无限感 */}
  <div
    class="absolute left-0 top-0 bottom-0 w-8 md:w-16 bg-linear-to-r from-[#f2f2f2] to-transparent z-20 pointer-events-none"
  >
  </div>
  <div
    class="absolute right-0 top-0 bottom-0 w-8 md:w-16 bg-linear-to-l from-[#f2f2f2] to-transparent z-20 pointer-events-none"
  >
  </div>

  {/* 滚动容器 */}
  <div
    class="movie-scroll-container flex overflow-x-auto gap-4 md:gap-6 pb-8 pt-4 px-4 md:px-8 snap-x snap-mandatory scrollbar-hide items-center"
    style="scrollbar-width: none; -ms-overflow-style: none;"
    data-lenis-prevent
  >
    {
      posts.map((post) => (
        <a
          href={`/movie/${post.id.replace(/\.mdx?$/, "")}/`}
          class="relative shrink-0 snap-center w-40 md:w-[200px] aspect-2/3 group/card transition-all duration-500 ease-out hover:scale-105 hover:-translate-y-2 z-0 hover:z-10"
        >
          {/* 图片容器 */}
          <div class="w-full h-full overflow-hidden rounded-sm shadow-ink relative">
            <Image
              src={post.data.coverImage}
              alt={post.data.title}
              width={400}
              class="w-full h-full object-cover filter grayscale contrast-[1.1] transition-all duration-700 group-hover/card:grayscale-0 group-hover/card:contrast-100"
            />

            {/* 评分印章 (悬停显示) */}
            <div class="absolute top-2 right-2 bg-ink-100/90 backdrop-blur-sm px-2 py-0.5 rounded-sm shadow-sm opacity-0 group-hover/card:opacity-100 translate-y-2 group-hover/card:translate-y-0 transition-all duration-300 flex items-center gap-1">
              <Icon name="mingcute:star-fill" class="w-3 h-3 text-vermilion" />
              <span class="text-xs font-serif font-bold text-ink-900">
                {post.data.rating.toFixed(1)}
              </span>
            </div>

            {/* 底部渐变标题 (悬停显示) */}
            <div class="absolute bottom-0 left-0 right-0 p-3 bg-linear-to-t from-ink-900/80 to-transparent opacity-0 group-hover/card:opacity-100 transition-opacity duration-300 flex items-end">
              <h4 class="text-ink-100 font-serif text-sm font-bold leading-tight line-clamp-2 shadow-black drop-shadow-md">
                {post.data.title}
              </h4>
            </div>
          </div>
        </a>
      ))
    }

    {/* 末尾占位，确保最后一张图能滚到中间 */}
    <div class="shrink-0 w-4 md:w-8"></div>
  </div>

  {/* 底部提示：Scroll */}
  <div
    class="text-center mt-2 opacity-0 group-hover/scroll:opacity-40 transition-opacity duration-500"
  >
    <span class="text-xs font-sans tracking-[0.2em] text-ink-300 uppercase"
      >Scroll Horizontally</span
    >
  </div>
</div>

<style>
  /* 隐藏滚动条但保留功能 */
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }
</style>

<script>
  // 将垂直滚轮事件转换为水平滚动
  const scrollContainer = document.querySelector(".movie-scroll-container");

  if (scrollContainer) {
    scrollContainer.addEventListener(
      "wheel",
      (evt) => {
        const e = evt as WheelEvent;
        // 如果滚动容器有水平溢出
        if (scrollContainer.scrollWidth > scrollContainer.clientWidth) {
          // 且滚轮主要是垂直方向滚动
          if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
            e.preventDefault();
            // 将 Y 轴滚动量加到 scrollLeft 上
            scrollContainer.scrollLeft += e.deltaY;
          }
        }
      },
      { passive: false }
    );
  }
</script>
