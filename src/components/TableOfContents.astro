---
// src/components/TableOfContents.astro
import type { MarkdownHeading } from "astro";

interface Props {
  headings: MarkdownHeading[];
}

const { headings } = Astro.props;

// 过滤规则：只显示 H2 和 H3
const toc = headings.filter((h) => h.depth > 1 && h.depth <= 3);
---

{
  toc.length > 0 && (
    <nav class="toc-container text-sm font-sans">
      <div class="flex items-center gap-2 mb-4 text-ink-900 dark:text-zinc-100">
        <span class="w-1 h-4 bg-vermilion rounded-sm" />
        <h2 class="font-serif font-bold text-lg tracking-wide">
          Catalog / 目录
        </h2>
      </div>

      <ul class="relative flex flex-col gap-1 border-l border-ink-200 dark:border-zinc-800 pl-0 ml-0.5">
        {toc.map((heading) => (
          <li style={`padding-left: ${(heading.depth - 2) * 1}rem`}>
            <a
              href={`#${heading.slug}`}
              class="toc-link block pl-4 py-1.5 border-l-2 border-transparent text-ink-500 dark:text-zinc-500 hover:text-vermilion dark:hover:text-vermilion hover:border-vermilion/50 -ml-px transition-all duration-300 text-balance leading-snug"
              data-slug={heading.slug}
            >
              {heading.text}
            </a>
          </li>
        ))}
      </ul>
    </nav>
  )
}

<script>
  const initTOC = () => {
    // 1. 滚动监听高亮 (IntersectionObserver)
    // 观察正文中的标题元素
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const id = entry.target.getAttribute("id");
          if (!id) return;

          // 注意：这里会同时选中“顶部折叠目录”和“右侧悬浮目录”里的对应链接
          // 实现了状态同步，非常完美
          const links = document.querySelectorAll(
            `.toc-link[data-slug="${id}"]`
          );

          if (entry.isIntersecting) {
            // 移除所有高亮
            document.querySelectorAll(".toc-link").forEach((l) => {
              l.classList.remove(
                "text-vermilion",
                "font-bold",
                "border-vermilion",
                "scale-105",
                "origin-left"
              );
              l.classList.add("border-transparent");
            });

            // 添加当前高亮
            links.forEach((link) => {
              link.classList.remove("border-transparent");
              link.classList.add(
                "text-vermilion",
                "font-bold",
                "border-vermilion",
                "scale-105",
                "origin-left"
              );
            });
          }
        });
      },
      { rootMargin: "-100px 0px -66% 0px" }
    );

    document.querySelectorAll("h2[id], h3[id]").forEach((h) => {
      observer.observe(h);
    });

    // 2. 点击平滑滚动逻辑
    const links = document.querySelectorAll(".toc-link");
    links.forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const targetId = link.getAttribute("href");
        if (!targetId) return;
        const targetElement = document.querySelector(
          targetId
        ) as HTMLElement | null;

        if (targetElement) {
          // 优先使用 window.lenis (如果你安装了平滑滚动库)
          if ((window as any).lenis) {
            (window as any).lenis.scrollTo(targetElement, {
              offset: -80,
              duration: 1.2,
            });
          } else {
            // 原生降级
            targetElement.scrollIntoView({ behavior: "smooth" });
          }
          history.pushState(null, "", targetId);
        }
      });
    });
  };

  document.addEventListener("astro:page-load", initTOC);
  // 增加 DOMContentLoaded 作为保险，防止首次加载不触发
  document.addEventListener("DOMContentLoaded", initTOC);
</script>
