---
// src/layouts/BlogPost.astro
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { Icon } from "astro-icon/components";

type Props = CollectionEntry<"blog">["data"];
const { title, description, pubDate, updatedDate, heroImage } = Astro.props;
---

<BaseLayout title={title} description={description}>
  <article class="py-12 md:py-20">
    {/* --- 头部区域 --- */}
    <header class="max-w-3xl mx-auto text-center mb-16 md:mb-24 px-4">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-ink-500 hover:text-vermilion transition-colors mb-8 text-sm tracking-widest uppercase group"
      >
        <Icon
          name="mingcute:arrow-left-line"
          class="group-hover:-translate-x-1 transition-transform"
        />
        <span>Return</span>
      </a>

      <div class="flex flex-col items-center gap-4">
        <div
          class="text-ink-500 text-sm font-sans tracking-widest uppercase flex items-center gap-3"
        >
          <FormattedDate date={pubDate} />
          {
            updatedDate && (
              <>
                <span class="w-1 h-1 rounded-full bg-ink-300" />
                <span class="italic">Updated</span>
              </>
            )
          }
        </div>

        <h1
          class="text-4xl md:text-6xl font-serif font-bold text-ink-900 leading-tight tracking-tight"
        >
          {title}
        </h1>

        <div class="w-12 h-1 bg-ink-900 mt-6"></div>
      </div>
    </header>

    {/* --- 核心图片 --- */}
    {
      heroImage && (
        <div class="w-full max-w-5xl mx-auto mb-16 md:mb-24 px-4 group">
          <div class="relative overflow-hidden rounded-sm shadow-ink transition-all duration-700">
            <Image
              src={heroImage}
              alt={title}
              width={1200}
              class="w-full h-auto object-cover filter grayscale contrast-[1.1] transition-all duration-1000 group-hover:grayscale-0 group-hover:contrast-100"
            />
            <div class="absolute inset-0 bg-ink-500/5 mix-blend-multiply pointer-events-none" />
          </div>
        </div>
      )
    }

    {/* --- 正文区域 --- */}
    <div class="prose prose-ink mx-auto px-4">
      <slot />
    </div>
  </article>
</BaseLayout>

<style>
  /* 现代东方风格 */
  .prose-ink {
    /* 基础设定：增加字间距，提升阅读的呼吸感 */
    color: var(--prose-body);
    font-family: var(--font-sans);
    font-size: 1.05rem;
    line-height: 2;
    letter-spacing: 0.02em;
    max-width: 65ch; /* 限制行长 */
    margin-left: auto;
    margin-right: auto;
  }

  /* 段落排版 */
  .prose-ink :global(p) {
    margin-bottom: 1.6em;
    text-wrap: pretty;
  }

  /* 标题排版 */
  .prose-ink :global(h1),
  .prose-ink :global(h2),
  .prose-ink :global(h3),
  .prose-ink :global(h4) {
    font-family: var(--font-serif);
    color: var(--prose-heading);
    font-weight: 600;
    letter-spacing: 0.05em;
    margin-top: 2.5em;
    margin-bottom: 1em;
    position: relative;
  }

  /* H2 特殊装饰：左侧竖线或底部线条 */
  .prose-ink :global(h2) {
    font-size: 1.8em;
    border-bottom: 1px solid var(--border-color); /* 淡墨色分割线 */
    padding-bottom: 0.3em;
  }

  .prose-ink :global(h3) {
    font-size: 1.4em;
    margin-top: 2em;
  }

  /* 斜体样式 */
  .prose-ink :global(em) {
    font-size: 1.05em;
    font-weight: 600;
  }

  /* 列表样式 */
  .prose-ink :global(ul),
  .prose-ink :global(ol) {
    margin: 1.5em 0;
    padding-left: 1.5em; /* 为自定义符号留出空间 */
    list-style: none; /* 移除默认样式 */
  }

  .prose-ink :global(li) {
    margin-bottom: 0.8em; /* 列表项之间的间距 */
    position: relative;
    padding-left: 0.5em;
  }

  /* 无序列表：使用朱红色的小方块或菱形，体现东方几何感 */
  .prose-ink :global(ul > li::before) {
    content: "";
    position: absolute;
    left: -1.2em;
    top: 0.65em; /* 视觉对齐 */
    width: 6px;
    height: 6px;
    background-color: var(--color-vermilion); /* 朱红色变量 */
    transform: rotate(45deg); /* 旋转成菱形 */
    opacity: 0.8;
  }

  /* 有序列表：使用衬线数字，颜色加深 */
  .prose-ink :global(ol) {
    counter-reset: list-counter;
  }
  .prose-ink :global(ol > li::before) {
    content: counter(list-counter) ".";
    counter-increment: list-counter;
    position: absolute;
    left: -1.5em;
    color: var(--color-vermilion);
    font-family: var(--font-serif);
    font-weight: bold;
    font-style: italic;
  }

  /* 嵌套列表处理 */
  .prose-ink :global(ul ul),
  .prose-ink :global(ol ol),
  .prose-ink :global(ul ol),
  .prose-ink :global(ol ul) {
    margin: 0.5em 0;
    font-size: 0.95em;
  }

  /* 链接与强调 */
  .prose-ink :global(strong) {
    color: var(--prose-bold);
    font-weight: 700;
    background: linear-gradient(
      180deg,
      transparent 60%,
      var(--prose-highlight) 0
    );
  }

  .prose-ink :global(a) {
    color: var(--prose-link);
    text-decoration: none;
    border-bottom: 1px solid var(--prose-link-border);
    transition: all 0.3s ease;
    padding-bottom: 1px;
  }
  .prose-ink :global(a:hover) {
    color: var(--color-vermilion);
    border-bottom-color: var(--color-vermilion);
  }

  /* 引用块 */
  .prose-ink :global(blockquote) {
    margin: 2em 0;
    padding: 1em 1.5em;
    border-left: 4px solid var(--prose-quote-border); /* 深墨色边框 */
    background-color: var(--prose-quote-bg); /* 极淡的米色/纸色背景 */
    color: var(--prose-quote-text);
    font-style: italic;
    font-family: var(--font-serif);
    border-radius: 0 4px 4px 0;
  }
  /* 去除引用中第一段和最后一段的默认 margin */
  .prose-ink :global(blockquote p:first-of-type) {
    margin-top: 0;
  }
  .prose-ink :global(blockquote p:last-of-type) {
    margin-bottom: 0;
  }

  /* 图片 */
  .prose-ink :global(img) {
    margin: 2.5em auto;
    display: block;
    border-radius: 4px;
    box-shadow: var(--shadow-ink);
    filter: grayscale(100%);
    transition:
      filter 0.5s ease,
      transform 0.3s ease;
  }
  .prose-ink :global(img:hover) {
    filter: grayscale(0%);
    transform: scale(1.01);
  }

  /* 行内代码与分割线 */
  .prose-ink :global(:not(pre) > code) {
    font-family: "Menlo", "Monaco", "Courier New", monospace;
    background-color: var(--prose-code-bg);
    color: var(--prose-code-text);
    padding: 0.2em 0.4em;
    border-radius: 4px;
    font-size: 0.85em;
  }

  .prose-ink :global(hr) {
    border: 0;
    height: 1px;
    background: linear-gradient(
      to right,
      transparent,
      var(--prose-link-border),
      transparent
    );
    margin: 4em 0;
    position: relative;
  }
  /* 分割线中间加一个小装饰（可选） */
  .prose-ink :global(hr::after) {
    content: "§"; /* 或者 "•" */
    position: absolute;
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
    background-color: var(--bg-body);
    padding: 0 1em;
    color: var(--text-muted);
    font-family: var(--font-serif);
  }

  /* 表格 */
  .prose-ink :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2em 0;
    font-size: 0.95em;
  }
  .prose-ink :global(th) {
    text-align: left;
    padding: 0.75em;
    border-bottom: 2px solid var(--prose-heading);
    font-family: var(--font-serif);
    color: var(--prose-heading);
  }
  .prose-ink :global(td) {
    padding: 0.75em;
    border-bottom: 1px solid var(--border-color);
    vertical-align: top;
  }
</style>

{/* --- macOS 风格代码块样式 --- */}
<style is:global>
  /* 容器 */
  pre.astro-code {
    display: block;
    position: relative;
    overflow: hidden;
    margin: 2em 0;
    padding: 0;
    max-width: 100%;
    box-sizing: border-box;
    border-radius: 8px;
    box-shadow: var(--shadow-ink);
    font-size: 1rem;
    transition:
      max-height 0.3s ease-out,
      background-color 0.3s ease;
    background-color: var(--code-block-bg) !important;
    border: 1px solid var(--border-color);
  }

  /* 标题栏 */
  pre.astro-code::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    z-index: 10;
    height: 2.6rem;
    width: 100%;

    background-color: var(--code-header-bg);
    border-bottom: 1px solid var(--code-header-border);

    /* 红黄绿按钮 */
    background-image: radial-gradient(
        circle at 1.5rem 1.3rem,
        #ff5f56 0.375rem,
        transparent 0.375rem
      ),
      radial-gradient(
        circle at 2.75rem 1.3rem,
        #ffbd2e 0.375rem,
        transparent 0.375rem
      ),
      radial-gradient(
        circle at 4rem 1.3rem,
        #27c93f 0.375rem,
        transparent 0.375rem
      );
    background-repeat: no-repeat;
  }

  /* 语言提示 */
  pre.astro-code::after {
    content: attr(data-language);
    position: absolute;
    top: 0.25rem;
    right: 5.5rem;
    padding: 0.125rem 0.5rem;
    font-size: 1.1rem;
    font-weight: 600;
    font-family: var(--font-sans);
    text-transform: uppercase;
    z-index: 12;
    display: inline-block;
    color: var(--text-muted);
  }

  /* 代码区域 */
  pre.astro-code > code {
    display: block;
    width: 100%;
    margin-top: 2.6rem;
    padding: 1rem 1.5rem 1.5rem 3rem;
    counter-reset: line;
    box-sizing: border-box;
    overflow: auto;
    max-height: 47.5rem;
    line-height: 1;
    overscroll-behavior: none;
  }

  pre.astro-code.collapsed > code {
    max-height: 21rem;
  }

  /* 按钮 */
  pre.astro-code .astro-code-icon-base {
    position: absolute;
    top: 0.3rem;
    width: 2rem;
    height: 2rem;
    padding: 0.125rem;
    border-radius: 0.25rem;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 15;
  }

  pre.astro-code .astro-code-icon-btn {
    border: none;
    background-color: transparent;
    cursor: pointer;
    transition: all 0.2s;
    outline: none;
    color: var(--text-muted);
  }

  pre.astro-code .astro-code-icon-btn:hover {
    color: var(--color-vermilion);
  }

  pre.astro-code .toggle-btn {
    right: 3.25rem;
  }
  pre.astro-code .copy-btn,
  pre.astro-code .copy-success {
    right: 1rem;
  }

  pre.astro-code .copy-success {
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
    color: var(--color-vermilion);
  }
  pre.astro-code .copy-success.show {
    opacity: 1;
  }

  /* 行号 */
  .astro-code .line {
    display: block;
    position: relative;
    max-width: 100%;
    box-sizing: border-box;
    min-height: 1rem;
  }
  .astro-code .line::before {
    content: counter(line);
    counter-increment: line;
    position: absolute;
    top: 0;
    left: -3.5rem;
    width: 2.5rem;
    text-align: right;
    opacity: 0.5;
    user-select: none;
    pointer-events: none;
    color: var(--text-muted);
  }

  /* 滚动条 */
  pre.astro-code > code::-webkit-scrollbar {
    width: 10px;
    height: 10px;
  }
  pre.astro-code > code::-webkit-scrollbar-track {
    background: transparent;
  }
  pre.astro-code > code::-webkit-scrollbar-thumb {
    background-color: var(--code-scroll-thumb);
    border-radius: 8px;
    border: 3px solid transparent;
    background-clip: content-box;
  }
  pre.astro-code > code::-webkit-scrollbar-thumb:hover {
    background-color: var(--code-scroll-hover);
  }
  pre.astro-code > code::-webkit-scrollbar-corner {
    background: transparent;
  }

  /* 移动端适配 */
  .prose-ink li > pre.astro-code {
    margin-left: -2em;
    width: calc(100% + 2em);
    max-width: calc(100% + 2em);
  }
  @media (max-width: 640px) {
    .prose-ink li > pre.astro-code {
      margin-left: -1em;
      width: calc(100% + 1em);
      max-width: calc(100% + 1em);
    }
  }
</style>

<script>
  function initCodeBlockFeatures() {
    if (document.body.dataset.codeFeaturesInitialized === "true") return;
    document.body.dataset.codeFeaturesInitialized = "true";

    const allCodeBlocks = document.querySelectorAll("pre.astro-code");

    allCodeBlocks.forEach((block) => {
      const pre = block as HTMLElement;

      const lang =
        pre.getAttribute("lang") || pre.getAttribute("data-language");
      if (lang) pre.dataset.language = lang;

      const codeElement = pre.querySelector("code");
      if (!codeElement || !(codeElement instanceof HTMLElement)) return;
      // ==========================================
      // 【1. Code 滚动锁】: 防止代码滚到底后页面跟着滚
      // ==========================================
      codeElement.addEventListener(
        "wheel",
        (e) => {
          const delta = e.deltaY;
          const { scrollTop, scrollHeight, clientHeight } = codeElement;
          const tolerance = 1;
          const isAtTop = scrollTop <= 0;
          const isAtBottom =
            scrollTop + clientHeight >= scrollHeight - tolerance;

          if ((delta < 0 && isAtTop) || (delta > 0 && isAtBottom)) {
            e.preventDefault();
          }
          e.stopPropagation();
        },
        { passive: false }
      );

      // ==========================================
      // 【2. Header 滚动代理】: 解决标题栏“死区”问题
      // ==========================================
      // 当鼠标悬停在 margin-top 腾出的标题栏区域时，事件目标是 pre
      // 我们手动把这里的滚轮事件“转发”给 codeElement
      pre.addEventListener(
        "wheel",
        (e) => {
          if (e.target === pre) {
            e.preventDefault(); // 同样要禁止页面滚动
            codeElement.scrollTop += e.deltaY;
          }
        },
        { passive: false }
      );

      // ==========================================
      // 下面是原有的复制和折叠逻辑 (保持不变)
      // ==========================================
      const copyButton = document.createElement("button");
      copyButton.className =
        "astro-code-icon-base astro-code-icon-btn copy-btn";
      copyButton.innerHTML = '<span class="mingcute--copy-line"></span>';

      const successMessage = document.createElement("span");
      successMessage.className = "astro-code-icon-base copy-success";
      successMessage.innerHTML = '<span class="mingcute--check-fill"></span>';

      pre.appendChild(copyButton);
      pre.appendChild(successMessage);

      copyButton.addEventListener("click", () => {
        const allLines = codeElement.querySelectorAll(".line");
        let codeToCopy;
        if (allLines.length > 0) {
          codeToCopy = Array.from(allLines)
            .map((line) => line.textContent || "")
            .join("\n");
        } else {
          codeToCopy = codeElement.innerText || "";
        }
        navigator.clipboard
          .writeText(codeToCopy)
          .then(() => {
            successMessage.classList.add("show");
            copyButton.style.display = "none";
            setTimeout(() => {
              successMessage.classList.remove("show");
              copyButton.style.display = "flex";
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy text: ", err);
          });
      });

      const lines = pre.querySelectorAll(".line");
      if (lines.length > 12) {
        pre.classList.add("collapsed");
        const toggleBtn = document.createElement("button");
        toggleBtn.className =
          "astro-code-icon-base astro-code-icon-btn toggle-btn";
        const iconSpan = document.createElement("span");
        iconSpan.className = "mingcute--down-fill";
        toggleBtn.appendChild(iconSpan);
        pre.appendChild(toggleBtn);

        toggleBtn.addEventListener("click", () => {
          const isCollapsed = pre.classList.toggle("collapsed");
          if (isCollapsed) {
            iconSpan.className = "mingcute--down-fill";
            pre.scrollIntoView({ behavior: "smooth", block: "nearest" });
          } else {
            iconSpan.className = "mingcute--up-fill";
          }
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    initCodeBlockFeatures();
  });
  document.addEventListener("astro:page-load", () => {
    initCodeBlockFeatures();
  });
</script>
