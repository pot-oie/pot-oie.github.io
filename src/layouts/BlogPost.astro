---
// src/layouts/BlogPost.astro
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";
import { Icon } from "astro-icon/components";

type Props = CollectionEntry<"blog">["data"];
const { title, description, pubDate, updatedDate, heroImage } = Astro.props;
---

<BaseLayout title={title} description={description}>
  <article class="py-12 md:py-20">
    {/* --- 头部区域：极简留白 --- */}
    <header class="max-w-3xl mx-auto text-center mb-16 md:mb-24 px-4">
      <a
        href="/"
        class="inline-flex items-center gap-2 text-ink-500 hover:text-vermilion transition-colors mb-8 text-sm tracking-widest uppercase group"
      >
        <Icon
          name="mingcute:arrow-left-line"
          class="group-hover:-translate-x-1 transition-transform"
        />
        <span>Return</span>
      </a>

      <div class="flex flex-col items-center gap-4">
        <div
          class="text-ink-500 text-sm font-sans tracking-widest uppercase flex items-center gap-3"
        >
          <FormattedDate date={pubDate} />
          {
            updatedDate && (
              <>
                <span class="w-1 h-1 rounded-full bg-ink-300" />
                <span class="italic">Updated</span>
              </>
            )
          }
        </div>

        <h1
          class="text-4xl md:text-6xl font-serif font-bold text-ink-900 leading-tight tracking-tight"
        >
          {title}
        </h1>

        <div class="w-12 h-1 bg-ink-900 mt-6"></div>
      </div>
    </header>

    {/* --- 核心图片：黑白->彩色交互 --- */}
    {
      heroImage && (
        <div class="w-full max-w-5xl mx-auto mb-16 md:mb-24 px-4 group">
          <div class="relative overflow-hidden rounded-sm shadow-ink transition-all duration-700">
            <Image
              src={heroImage}
              alt={title}
              width={1200}
              class="w-full h-auto object-cover filter grayscale contrast-[1.1] transition-all duration-1000 group-hover:grayscale-0 group-hover:contrast-100"
            />
            {/* 纹理遮罩，增加纸张感 */}
            <div class="absolute inset-0 bg-ink-500/5 mix-blend-multiply pointer-events-none" />
          </div>
        </div>
      )
    }

    {/* --- 正文区域 --- */}
    <div class="prose prose-ink mx-auto px-4">
      <slot />
    </div>
  </article>
</BaseLayout>

<style>
  /* 定制 Prose 内部样式以匹配墨色系统 */
  .prose-ink {
    color: var(--color-ink-700);
    font-family: var(--font-sans);
  }
  .prose-ink :global(h1),
  .prose-ink :global(h2),
  .prose-ink :global(h3) {
    font-family: var(--font-serif);
    color: var(--color-ink-900);
    margin-top: 2em;
  }
  .prose-ink :global(strong) {
    color: var(--color-ink-900);
    font-weight: 700;
  }
  .prose-ink :global(a) {
    color: var(--color-ink-900);
    text-decoration-color: var(--color-ink-300);
    text-underline-offset: 4px;
  }
  .prose-ink :global(a:hover) {
    color: var(--color-vermilion);
    text-decoration-color: var(--color-vermilion);
  }
  .prose-ink :global(blockquote) {
    border-left-color: var(--color-ink-900);
    color: var(--color-ink-500);
  }
  .prose-ink :global(img) {
    filter: grayscale(100%);
    transition: filter 0.5s ease;
    border-radius: 4px;
  }
  .prose-ink :global(img:hover) {
    filter: grayscale(0%);
  }
</style>

<script>
  function initCodeBlockFeatures() {
    // 防止重复初始化
    if (document.body.dataset.codeFeaturesInitialized === "true") return;
    document.body.dataset.codeFeaturesInitialized = "true";

    const allCodeBlocks = document.querySelectorAll("pre.astro-code");

    allCodeBlocks.forEach((pre) => {
      // 设置语言
      const lang =
        pre.getAttribute("lang") || pre.getAttribute("data-language");
      if (lang) {
        // @ts-ignore
        pre.dataset.language = lang;
      }

      // 创建复制按钮
      const copyButton = document.createElement("button");
      copyButton.className =
        "astro-code-icon-base astro-code-icon-btn copy-btn";
      copyButton.innerHTML = '<span class="mingcute--copy-line"></span>';

      // 创建成功提示
      const successMessage = document.createElement("span");
      successMessage.className = "astro-code-icon-base copy-success";
      successMessage.innerHTML = '<span class="mingcute--check-fill"></span>';

      // 添加到 DOM
      pre.appendChild(copyButton);
      pre.appendChild(successMessage);

      // 点击事件
      copyButton.addEventListener("click", () => {
        const codeElement = pre.querySelector("code");
        if (!codeElement) return;

        // 重构文本获取方式，避免多余空行
        const allLines = codeElement.querySelectorAll(".line");
        let codeToCopy;

        if (allLines.length > 0) {
          // 如果有 .line 元素 (Shiki)，则手动拼接
          codeToCopy = Array.from(allLines)
            .map((line) => line.textContent || "")
            .join("\n");
        } else {
          // 否则，回退到 innerText (适用于没有 .line 的普通 <code>)
          codeToCopy = codeElement.innerText || "";
        }

        navigator.clipboard
          .writeText(codeToCopy)
          .then(() => {
            successMessage.classList.add("show");
            copyButton.style.display = "none";

            setTimeout(() => {
              successMessage.classList.remove("show");
              copyButton.style.display = "flex";
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy text: ", err);
            alert("复制失败!");
          });
      });

      // 折叠功能
      // 获取所有行元素 (Shiki 生成的 .line)
      const lines = pre.querySelectorAll(".line");
      // 阈值：12行
      const LINE_THRESHOLD = 12;

      if (lines.length > LINE_THRESHOLD) {
        // 超过 12 行进行折叠处理
        pre.classList.add("collapsed");

        // 创建切换按钮
        const toggleBtn = document.createElement("button");
        // 应用基类 + 按钮基类 + 具体的定位类(toggle-btn)
        toggleBtn.className =
          "astro-code-icon-base astro-code-icon-btn toggle-btn";

        // 创建图标元素 (默认显示“向下/展开”)
        const iconSpan = document.createElement("span");
        iconSpan.className = "mingcute--down-fill";
        toggleBtn.appendChild(iconSpan);

        // 添加到 DOM
        pre.appendChild(toggleBtn);

        // 绑定点击事件
        toggleBtn.addEventListener("click", () => {
          // 切换 collapsed 类
          const isCollapsed = pre.classList.toggle("collapsed");

          if (isCollapsed) {
            // 变成了折叠状态 -> 显示“向下”箭头
            iconSpan.className = "mingcute--down-fill";
            pre.scrollIntoView({ behavior: "smooth", block: "nearest" });
          } else {
            // 变成了展开状态 -> 显示“向上”箭头
            iconSpan.className = "mingcute--up-fill";
          }
        });
      }
    });
  }
  // 页面加载生命周期
  document.addEventListener("DOMContentLoaded", () => {
    initCodeBlockFeatures();
  });
  document.addEventListener("astro:page-load", () => {
    initCodeBlockFeatures();
  });
</script>
