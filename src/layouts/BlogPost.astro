---
// src/layouts/BlogPost.astro
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "./BaseLayout.astro";
import FormattedDate from "../components/FormattedDate.astro";
import TableOfContents from "../components/TableOfContents.astro";
import { Icon } from "astro-icon/components";
import type { MarkdownHeading } from "astro";

type Props = CollectionEntry<"blog">["data"] & {
  headings?: MarkdownHeading[];
};

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  headings = [],
} = Astro.props;
---

<BaseLayout title={title} description={description}>
  {
    /* çˆ¶çº§å®¹å™¨ï¼šrelative ç”¨äºå®šä½ä¸Šä¸‹æ–‡ï¼ˆè™½ç„¶ fixed æ˜¯ç›¸å¯¹äºè§†å£çš„ï¼Œä½†ä¿æŒç»“æ„æ¸…æ™°ï¼‰ */
  }
  <div class="relative w-full">
    {/* --- [A] å³ä¾§æ‚¬æµ®ç›®å½• (ä»…åœ¨ 2xl/1536px+ å±å¹•æ˜¾ç¤º) --- */}
    {
      /* è®¡ç®—é€»è¾‘ï¼š
        left-[calc(50%+26rem)]
        - 50%: å±å¹•ä¸­çº¿
        - 24rem: æ­£æ–‡æœ€å¤§å®½åº¦ (max-w-3xl = 48rem) çš„ä¸€åŠ
        - 2rem: é—´è· gap
        ç»“æœï¼šç›®å½•ç´§è´´ç€æ­£æ–‡å³ä¾§è¾¹ç¼˜ + 32px çš„ä½ç½®å¼€å§‹
    */
    }
    <aside
      class="hidden 2xl:block fixed top-32 left-[calc(50%+26rem)] w-72 h-[calc(100vh-10rem)] overflow-y-auto overflow-x-hidden z-10 opacity-80 hover:opacity-100 transition-opacity duration-300"
    >
      <TableOfContents headings={headings} />
    </aside>

    <article class="py-12 md:py-20 w-full max-w-3xl mx-auto px-4 relative z-0">
      {/* --- å¤´éƒ¨åŒºåŸŸ --- */}
      <header class="text-center mb-16 md:mb-24">
        <a
          href="/"
          class="inline-flex items-center gap-2 text-ink-500 hover:text-vermilion transition-all mb-8 text-sm tracking-widest uppercase group active:scale-95"
        >
          <Icon
            name="mingcute:arrow-left-line"
            class="group-hover:-translate-x-1 transition-transform"
          />
          <span>Return</span>
        </a>

        <div class="flex flex-col items-center gap-4">
          <div
            class="text-ink-500 text-sm font-sans tracking-widest uppercase flex items-center gap-3"
          >
            <FormattedDate date={pubDate} />
            {
              updatedDate && (
                <>
                  <span class="w-1 h-1 rounded-full bg-ink-300" />
                  <span class="italic">Updated</span>
                </>
              )
            }
          </div>

          <h1
            class="text-4xl md:text-6xl font-serif font-bold text-ink-900 dark:text-zinc-100 leading-tight tracking-tight"
          >
            {title}
          </h1>

          <div
            class="w-12 h-1 bg-ink-900 dark:bg-zinc-100 mt-6 transition-colors"
          >
          </div>
        </div>
      </header>

      {/* --- æ ¸å¿ƒå›¾ç‰‡ --- */}
      {
        heroImage && (
          <div class="w-full mb-16 md:mb-24 group">
            <div class="relative overflow-hidden rounded-sm shadow-ink transition-all duration-700">
              <Image
                src={heroImage}
                alt={title}
                width={1200}
                loading="eager"
                fetchpriority="high"
                quality={80}
                format="webp"
                class="w-full h-auto object-cover filter grayscale contrast-[1.1] transition-all duration-1000 md:group-hover:grayscale-0 md:group-hover:contrast-100 active:grayscale-0 active:contrast-100 active:scale-[0.99] active:duration-300"
              />
              <div class="absolute inset-0 bg-ink-500/5 mix-blend-multiply pointer-events-none" />
            </div>
          </div>
        )
      }

      {/* --- [B] é¡¶éƒ¨æŠ˜å ç›®å½• (åœ¨ 2xl ä»¥ä¸‹å±å¹•æ˜¾ç¤º) --- */}
      {
        headings.length > 0 && (
          <div class="2xl:hidden mb-12">
            <details class="bg-ink-50 dark:bg-zinc-800/50 rounded-sm border border-ink-200 dark:border-zinc-700 group open:shadow-ink transition-all duration-300">
              <summary class="p-4 font-serif font-bold text-ink-900 dark:text-zinc-100 cursor-pointer flex items-center justify-between list-none select-none">
                <div class="flex items-center gap-2">
                  <Icon
                    name="mingcute:list-check-line"
                    class="w-5 h-5 text-vermilion"
                  />
                  <span>Table of Contents</span>
                </div>
                <Icon
                  name="mingcute:down-line"
                  class="w-5 h-5 transition-transform duration-300 group-open:rotate-180 text-ink-400"
                />
              </summary>
              <div class="px-4 pb-6 pt-2 border-t border-ink-200/50 dark:border-zinc-700/50">
                <TableOfContents headings={headings} />
              </div>
            </details>
          </div>
        )
      }

      {/* --- æ­£æ–‡å†…å®¹ --- */}
      <div class="prose prose-ink">
        <slot />
      </div>
    </article>
  </div>
</BaseLayout>

<script>
  // ä»£ç å—äº¤äº’é€»è¾‘
  function initCodeBlockFeatures() {
    if (document.body.dataset.codeFeaturesInitialized === "true") return;
    document.body.dataset.codeFeaturesInitialized = "true";

    const allCodeBlocks = document.querySelectorAll("pre.astro-code");

    allCodeBlocks.forEach((block) => {
      const pre = block as HTMLElement;

      const lang =
        pre.getAttribute("lang") || pre.getAttribute("data-language");
      if (lang) pre.dataset.language = lang;

      const codeElement = pre.querySelector("code");
      if (!codeElement || !(codeElement instanceof HTMLElement)) return;

      // ã€Code æ»šåŠ¨é”ã€‘
      codeElement.addEventListener(
        "wheel",
        (e) => {
          const delta = e.deltaY;
          const { scrollTop, scrollHeight, clientHeight } = codeElement;
          const tolerance = 1;
          const isAtTop = scrollTop <= 0;
          const isAtBottom =
            scrollTop + clientHeight >= scrollHeight - tolerance;

          if ((delta < 0 && isAtTop) || (delta > 0 && isAtBottom)) {
            e.preventDefault();
          }
          e.stopPropagation();
        },
        { passive: false }
      );

      // ã€Header æ»šåŠ¨ä»£ç†ã€‘
      pre.addEventListener(
        "wheel",
        (e) => {
          if (e.target === pre) {
            e.preventDefault();
            codeElement.scrollTop += e.deltaY;
          }
        },
        { passive: false }
      );

      // ã€å¤åˆ¶å’ŒæŠ˜å é€»è¾‘ã€‘
      const copyButton = document.createElement("button");
      copyButton.className =
        "astro-code-icon-base astro-code-icon-btn copy-btn";
      copyButton.innerHTML = '<span class="mingcute--copy-line"></span>';

      const successMessage = document.createElement("span");
      successMessage.className = "astro-code-icon-base copy-success";
      successMessage.innerHTML = '<span class="mingcute--check-fill"></span>';

      pre.appendChild(copyButton);
      pre.appendChild(successMessage);

      copyButton.addEventListener("click", () => {
        const allLines = codeElement.querySelectorAll(".line");
        let codeToCopy;
        if (allLines.length > 0) {
          codeToCopy = Array.from(allLines)
            .map((line) => line.textContent || "")
            .join("\n");
        } else {
          codeToCopy = codeElement.innerText || "";
        }
        navigator.clipboard
          .writeText(codeToCopy)
          .then(() => {
            successMessage.classList.add("show");
            copyButton.style.display = "none";
            setTimeout(() => {
              successMessage.classList.remove("show");
              copyButton.style.display = "flex";
            }, 2000);
          })
          .catch((err) => {
            console.error("Failed to copy text: ", err);
          });
      });

      const lines = pre.querySelectorAll(".line");
      if (lines.length > 12) {
        pre.classList.add("collapsed");
        const toggleBtn = document.createElement("button");
        toggleBtn.className =
          "astro-code-icon-base astro-code-icon-btn toggle-btn";
        const iconSpan = document.createElement("span");
        iconSpan.className = "mingcute--down-fill";
        toggleBtn.appendChild(iconSpan);
        pre.appendChild(toggleBtn);

        toggleBtn.addEventListener("click", () => {
          const isCollapsed = pre.classList.toggle("collapsed");
          if (isCollapsed) {
            iconSpan.className = "mingcute--down-fill";
            pre.scrollIntoView({ behavior: "smooth", block: "nearest" });
          } else {
            iconSpan.className = "mingcute--up-fill";
          }
        });
      }
    });
  }

  document.addEventListener("DOMContentLoaded", () => {
    initCodeBlockFeatures();
  });
  document.addEventListener("astro:page-load", () => {
    initCodeBlockFeatures();
  });

  // è°ƒè¯•ä»£ç å—é£æ ¼
  // å®šä¹‰åˆå§‹åŒ–å‡½æ•°
  function initCodeStyleToggle() {
    const codeBlocks = document.querySelectorAll("pre.astro-code");

    codeBlocks.forEach((pre) => {
      // 1. æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡æŒ‰é’®ï¼Œé˜²æ­¢é‡å¤æ·»åŠ 
      if (pre.querySelector(".style-toggle-btn")) return;

      // 2. åˆ›å»ºæŒ‰é’®å…ƒç´ 
      const btn = document.createElement("button");
      btn.className = "style-toggle-btn";
      btn.innerHTML = `
        <span class="icon-macos">ğŸ’»</span>
        <span class="icon-ink">ğŸ¨</span>
      `;
      btn.title = "åˆ‡æ¢ä»£ç é£æ ¼ (macOS / Ink)";

      // 3. ç‚¹å‡»äº‹ä»¶ï¼šåˆ‡æ¢ class
      btn.addEventListener("click", () => {
        // åˆ‡æ¢ .style-ink ç±»å
        pre.classList.toggle("style-ink");

        // å¯é€‰ï¼šæ·»åŠ ä¸€ç‚¹ç‚¹å‡»åŠ¨ç”»åé¦ˆ
        btn.style.transform = "scale(0.9)";
        setTimeout(() => (btn.style.transform = "scale(1)"), 150);
      });

      // 4. å°†æŒ‰é’®æ·»åŠ åˆ°ä»£ç å—ä¸­
      pre.appendChild(btn);
    });
  }

  // ç«‹å³æ‰§è¡Œä¸€æ¬¡
  initCodeStyleToggle();

  // å¦‚æœä½¿ç”¨äº† View Transitionsï¼Œæ¯æ¬¡é¡µé¢è·³è½¬éƒ½è¦æ‰§è¡Œ
  document.addEventListener("astro:page-load", initCodeStyleToggle);
</script>
