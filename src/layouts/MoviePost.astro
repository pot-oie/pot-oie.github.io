---
// src/layouts/MoviePost.astro

import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';
import BaseHead from '../components/BaseHead.astro';
import Footer from '../components/Footer.astro';
import FormattedDate from '../components/FormattedDate.astro';
import Header from '../components/Header.astro';
import { Icon } from 'astro-icon/components';

type Props = CollectionEntry<'movie'>['data'];

// 从 props 中获取所有电影数据
const { 
  title, 
  coverImage, 
  rating, 
  viewingDate, 
  releaseDate, 
  shortReview 
} = Astro.props;

// 复用 MovieCard 中的星级评分逻辑
function generateStars(rating: number) {
  const totalStars = 5;
  const stars = [];
  for (let i = 1; i <= totalStars; i++) {
    if (rating >= i) stars.push('mingcute:star-fill');
    else if (rating >= i - 0.5) stars.push('mingcute:star-half-fill');
    else stars.push('mingcute:star-line');
  }
  return stars;
}
const starIcons = generateStars(rating);
---

<html lang="zh-CN">
  <head>
    <BaseHead title={title} description={shortReview} image={coverImage} /> 
    <style>
      /* 定义文章区域的基本样式 */
      .prose {
        width: 720px;
        max-width: calc(100% - 2em);
        margin: auto;
        padding: 1em;
        /* 确保长评内容有良好的可读性 */
        font-size: 1.125rem; /* 18px */
        line-height: 1.8;
      }
      .prose p {
        margin-bottom: 1.5em;
      }
      .prose h1, .prose h2, .prose h3 {
        margin-bottom: 0.5em;
        margin-top: 1.5em;
      }
      .prose blockquote {
        border-left-width: 4px;
        padding-top: 8px;
        padding-bottom: 8px;
        margin: 1.5em 0;
        font-size: 1.2em;
        font-style: italic;
      }
    </style>
  </head>

  <body class="bg-white dark:bg-zinc-900 text-zinc-800 dark:text-zinc-200">
    <Header />
    <main class="py-16 md:py-24">
      <article>
        <div class="prose">
          
          {coverImage && (
            <div class="hidden md:block float-right ml-8 mb-6 w-1/3 max-w-[250px]">
              <Image 
                width={400} 
                height={600} 
                src={coverImage} 
                alt={title} 
                class="rounded-lg shadow-xl"
              />
            </div>
          )}

          <h1 class="text-4xl md:text-5xl font-bold text-zinc-900 dark:text-zinc-100">{title}</h1>

          <div class="flex items-center text-yellow-400 my-4">
            {starIcons.map(iconName => (
              <Icon name={iconName} class="w-6 h-6" />
            ))}
            <span class="ml-3 text-2xl text-zinc-700 dark:text-zinc-300">{rating.toFixed(1)}</span>
          </div>

          {coverImage && (
            <div class="block md:hidden my-6">
              <Image 
                width={400} 
                height={600} 
                src={coverImage} 
                alt={title} 
                class="rounded-lg shadow-xl w-full max-w-[300px] mx-auto"
              />
            </div>
          )}

          <div class="text-base text-zinc-500 dark:text-zinc-400 space-y-1 my-6 border-l-2 border-primary-500/30 pl-4">
            <p>
              <strong>观看于:</strong> <FormattedDate date={viewingDate} />
            </p>
            {releaseDate && (
              <p>
                <strong>上映于:</strong> <FormattedDate date={releaseDate} />
              </p>
            )}
          </div>

          {shortReview && (
            <blockquote class="text-zinc-700 dark:text-zinc-300">
              {shortReview}
            </blockquote>
          )}
          
          <hr class="my-8 border-zinc-200 dark:border-zinc-700"/>

          <div class="text-zinc-800 dark:text-zinc-200">
            <slot />
          </div>

        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>

<script>
  function setupThemeToggle() {
    const toggleBtn = document.getElementById('theme-toggle-btn');
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });
    }
  }

  // 页面加载生命周期
  document.addEventListener('DOMContentLoaded', () => {
    setupThemeToggle();
  });
  document.addEventListener('astro:page-load', () => {
    setupThemeToggle();
  });
</script>