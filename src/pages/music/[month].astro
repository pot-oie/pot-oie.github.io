---
// src/pages/music/[month].astro

import { getCollection, type CollectionEntry } from 'astro:content';
import MusicCalendar from '../../components/MusicCalendar.astro';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';

export async function getStaticPaths() {
  const allMusic = await getCollection('music');
  
  const months = new Map<string, CollectionEntry<'music'>[]>();
  for (const post of allMusic) {
    const pubDate = post.data.pubDate;
    const key = `${pubDate.getFullYear().toString().slice(-2)}-${String(pubDate.getMonth() + 1).padStart(2, '0')}`;
    
    if (!months.has(key)) {
      months.set(key, []);
    }
    months.get(key)!.push(post);
  }

  const now = new Date();
  const currentMonthKey = `${now.getFullYear().toString().slice(-2)}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  if (!months.has(currentMonthKey)) {
    months.set(currentMonthKey, []);
  }

  const allMonthKeys = [...months.keys()].sort().reverse();

  return allMonthKeys.map((monthKey, index) => {
    const prevKey = allMonthKeys[index + 1] || null;
    const nextKey = allMonthKeys[index - 1] || null;
    
    return {
      params: { month: monthKey },
      props: {
        musicForThisMonth: months.get(monthKey)!,
        prevMonthUrl: prevKey ? `/music/${prevKey}` : null,
        nextMonthUrl: nextKey ? `/music/${nextKey}` : null,
      },
    };
  });
}

const { month } = Astro.params;
const { musicForThisMonth, prevMonthUrl, nextMonthUrl } = Astro.props;

const [yearStr, monthStr] = month.split('-');
const dateForTitle = new Date(2000 + parseInt(yearStr), parseInt(monthStr) - 1, 1);
const pageTitle = `音乐日历 - ${dateForTitle.toLocaleString('zh-CN', { year: 'numeric', month: 'long' })}`;
const pageDescription = "我的音乐日历。";
---

<html lang="zh-CN">
<head>
  <BaseHead title={pageTitle} description={pageDescription} />
</head>
<body class="bg-white dark:bg-zinc-900">
  
  <Header />

  <main>
    {/* 缩小顶部 padding */}
    <section class="pt-4 md:pt-8 pb-16 md:pb-24">
      <div class="max-w-6xl mx-auto px-4">
        
        <MusicCalendar
          currentMonthKey={month}
          musicData={musicForThisMonth}
          prevMonthUrl={prevMonthUrl}
          nextMonthUrl={nextMonthUrl}
        />

      </div>
    </section>
  </main>
  
  <Footer />

</body>
</html>