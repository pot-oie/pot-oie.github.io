---
// src/pages/index.astro
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";
import RecentMusic from "../components/RecentMusic.astro";
import MovieScroll from "../components/MovieScroll.astro";
import { Icon } from "astro-icon/components";

// 获取博客文章
const allPosts = await getCollection("blog", ({ data }) => {
  return data.draft !== true;
});
const sortedPosts = allPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
const recentPosts = sortedPosts.slice(0, 5); // 首页显示 5 篇

// 随机文章逻辑
let randomPostUrl = "/blog";
if (allPosts.length > 0) {
  const randomIndex = Math.floor(Math.random() * allPosts.length);
  const randomPost = allPosts[randomIndex];
  const slug = randomPost.id.replace(/\.mdx?$/, "");
  randomPostUrl = `/blog/${slug}/`;
}

// 获取电影
const moviePosts = await getCollection("movie");
const recentMovies = moviePosts
  .sort(
    (a, b) =>
      new Date(b.data.viewingDate).valueOf() -
      new Date(a.data.viewingDate).valueOf()
  )
  .slice(0, 8);

const pageTitle = "首页";
const pageDescription = "Pot's Blog - 思想的流淌与记录";
---

<BaseLayout title={pageTitle} description={pageDescription}>
  {/* --- Hero Section: 极简留白 --- */}
  <section
    class="min-h-[40vh] flex flex-col justify-center items-start py-20 md:py-32"
  >
    <h1
      class="text-6xl md:text-8xl font-serif font-bold text-ink-900 dark:text-zinc-100 mb-6 tracking-tight transition-colors"
    >
      Pot's <span
        class="text-ink-300 dark:text-zinc-500 italic transition-colors"
        >Space</span
      >
    </h1>
    <p
      class="text-xl md:text-2xl text-ink-500 dark:text-zinc-400 max-w-xl leading-relaxed font-serif transition-colors"
    >
      做的还不够多，<br />说的还不够少。
    </p>
  </section>

  {/* --- Blog Section: 目录流 --- */}
  <section class="py-16">
    <div
      class="flex items-center justify-between mb-12 border-b border-ink-900 dark:border-zinc-700 pb-4 transition-colors"
    >
      <h2
        class="text-lg font-bold tracking-widest uppercase text-ink-900 dark:text-zinc-100 transition-colors"
      >
        Recent Writings / 最近在写
      </h2>
    </div>

    <div class="flex flex-col">
      {recentPosts.map((post) => <PostCard post={post} />)}
    </div>

    <div
      class="mt-12 flex flex-col sm:flex-row items-center justify-center gap-6 sm:gap-8"
    >
      {/* 主操作：View All (方框按钮) */}
      <a
        href="/blog"
        class="js-delayed-link inline-block px-8 py-3 border border-ink-300 dark:border-zinc-600 text-ink-500 dark:text-zinc-400 text-sm tracking-widest uppercase transition-all duration-300
               hover:border-vermilion hover:text-vermilion dark:hover:text-vermilion
               active:border-vermilion active:text-vermilion active:scale-95
               [&.is-active]:border-vermilion [&.is-active]:text-vermilion"
      >
        View All Archives
      </a>

      {/* 副操作：Random Walk (带图标) */}
      <a
        href={randomPostUrl}
        class="js-delayed-link inline-flex items-center gap-2 text-sm font-serif font-bold tracking-widest uppercase text-ink-400 dark:text-zinc-500 transition-all group
               hover:text-vermilion dark:hover:text-vermilion
               active:text-vermilion active:scale-95
               [&.is-active]:text-vermilion"
      >
        <Icon name="mingcute:random-line" class="w-4 h-4" />
        <span>Random Walk / 试试手气</span>
      </a>
    </div>
  </section>

  {/* --- Movie Section --- */}
  <section class="py-24">
    <div
      class="flex justify-between items-baseline mb-12 border-b border-ink-900 dark:border-zinc-700 pb-4 transition-colors"
    >
      <h2
        class="text-lg font-bold tracking-widest uppercase text-ink-900 dark:text-zinc-100 transition-colors leading-none"
      >
        Recent Watches / 最近在看
      </h2>

      {/* 视图切换按钮 */}
      <button
        id="movie-view-toggle"
        aria-label="切换视图"
        class="group text-ink-300 dark:text-zinc-500 hover:text-vermilion transition-all duration-300
               active:scale-90 active:text-vermilion translate-y-1"
      >
        <Icon name="tabler:layout-grid" class="w-6 h-6" id="movie-icon-grid" />
        <Icon
          name="tabler:movie"
          class="w-6 h-6 hidden"
          id="movie-icon-scroll"
        />
      </button>
    </div>

    {/* Grid View */}
    <div
      id="movie-grid-view"
      class="grid grid-cols-1 min-[340px]:grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-8 md:gap-x-6 md:gap-y-12 transition-opacity duration-300"
    >
      {
        recentMovies.map((movie) => {
          const slug = movie.id.replace(/\.mdx?$/, "");
          return (
            <div class="group">
              <a
                href={`/movie/${slug}/`}
                class="js-delayed-link block overflow-hidden rounded-sm shadow-ink relative aspect-2/3 active:scale-[0.98] active:duration-150 transition-all duration-500"
              >
                <img
                  src={movie.data.coverImage.src}
                  alt={movie.data.title}
                  transition:name={`movie-${slug}`}
                  class="w-full h-full object-cover transition-transform duration-700 
                         md:group-hover:scale-105 md:group-hover:grayscale-0 
                         group-active:scale-105 group-active:grayscale-0 
                         group-[.is-active]:scale-105 group-[.is-active]:grayscale-0
                         filter grayscale 
                         active:duration-200 group-[.is-active]:duration-200"
                />
              </a>
              <h3
                class="mt-3 text-lg font-serif font-bold text-ink-900 dark:text-zinc-200 
                       md:group-hover:text-vermilion 
                       group-active:text-vermilion group-[.is-active]:text-vermilion
                       transition-colors duration-300 active:duration-150 group-[.is-active]:duration-150"
              >
                {movie.data.title}
              </h3>
              <div class="flex text-yellow-600 dark:text-yellow-500 text-xs mt-1 gap-1">
                <span>★ {movie.data.rating}</span>
              </div>
            </div>
          );
        })
      }
    </div>

    {/* Scroll View */}
    <div
      id="movie-scroll-view"
      class="hidden transition-opacity duration-300 opacity-0"
    >
      <div class="movie-scroll-wrapper flex justify-center py-12">
        <MovieScroll posts={recentMovies} />
      </div>
    </div>
  </section>

  {/* --- Music Section --- */}
  <section
    class="py-16 border-t border-ink-100 dark:border-zinc-800 transition-colors"
  >
    <div class="flex items-baseline justify-between mb-12">
      <h2
        class="text-lg font-bold tracking-widest uppercase text-ink-900 dark:text-zinc-100 transition-colors"
      >
        On Repeat / 最近在听
      </h2>
    </div>
    <div class="max-w-2xl">
      <RecentMusic />
    </div>
  </section>
</BaseLayout>

<script>
  function setupPageInteractions() {
    // 电影视图切换逻辑
    const toggleBtn = document.getElementById("movie-view-toggle");
    const gridView = document.getElementById("movie-grid-view");
    const scrollView = document.getElementById("movie-scroll-view");
    const gridIcon = document.getElementById("movie-icon-grid");
    const scrollIcon = document.getElementById("movie-icon-scroll");

    if (toggleBtn && gridView && scrollView && gridIcon && scrollIcon) {
      if (toggleBtn.dataset.listenerAttached !== "true") {
        toggleBtn.dataset.listenerAttached = "true";
        const transitionDuration = 300;

        toggleBtn.addEventListener("click", () => {
          const isGridViewVisible = !gridView.classList.contains("hidden");

          if (isGridViewVisible) {
            // 切换到 Scroll
            gridIcon.classList.add("hidden");
            scrollIcon.classList.remove("hidden");
            gridView.classList.add("opacity-0");

            setTimeout(() => {
              gridView.classList.add("hidden");
              scrollView.classList.remove("hidden");
              void scrollView.offsetWidth; // 强制重绘
              scrollView.classList.remove("opacity-0");
              scrollView.classList.add("opacity-100");
            }, transitionDuration);
          } else {
            // 切换到 Grid
            gridIcon.classList.remove("hidden");
            scrollIcon.classList.add("hidden");
            scrollView.classList.remove("opacity-100");
            scrollView.classList.add("opacity-0");

            setTimeout(() => {
              scrollView.classList.add("hidden");
              gridView.classList.remove("hidden");
              void gridView.offsetWidth;
              gridView.classList.remove("opacity-0");
            }, transitionDuration);
          }
        });
      }
    }

    // 通用延迟跳转逻辑 (电影卡片 + 底部按钮)
    // 查找所有带 js-delayed-link 类的元素
    const links = document.querySelectorAll(".js-delayed-link");

    links.forEach((link) => {
      link.addEventListener("click", (e) => {
        const mouseEvent = e as MouseEvent;
        const target = e.currentTarget as HTMLAnchorElement;

        // 查找是否在 group 中 (用于电影卡片激活父级)
        const groupContainer = target.closest(".group");

        // 检查是否已经激活，或者是否按下了 ctrl/command
        const isAlreadyActive =
          target.classList.contains("is-active") ||
          (groupContainer && groupContainer.classList.contains("is-active"));

        if (mouseEvent.metaKey || mouseEvent.ctrlKey || isAlreadyActive) return;

        e.preventDefault();

        // A. 激活自身 (用于 View All 和 Random Walk 保持颜色)
        target.classList.add("is-active");

        // B. 如果有父级 Group 且不是链接本身 (用于电影卡片激活标题和图片)
        if (groupContainer && groupContainer !== target) {
          groupContainer.classList.add("is-active");
        }

        setTimeout(() => {
          window.location.href = target.href;
        }, 400);
      });
    });
  }

  document.addEventListener("DOMContentLoaded", setupPageInteractions);
  document.addEventListener("astro:page-load", setupPageInteractions);
</script>
