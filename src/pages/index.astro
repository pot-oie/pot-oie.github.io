---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";
import MovieCard from "../components/MovieCard.astro";
import MusicPlayer from "../components/MusicPlayer.astro";
import MovieDeck from "../components/MovieDeck.astro";
import { Icon } from "astro-icon/components";

// 查询 'src/content/blog/' 文件夹下的所有文章
// 类型过滤后按发布日期倒序排列
const allPosts = await getCollection("blog", ({ data }) => {
  return data.draft !== true;
});

const sortedPosts = allPosts.sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
const recentPosts = sortedPosts.slice(0, 3);

// 查询 'src/content/movie/' 文件夹下的所有电影
const moviePosts = await getCollection("movie");
// 按观影时间排序
const recentMovies = moviePosts.sort(
  (a, b) => new Date(b.data.viewingDate).valueOf() - new Date(a.data.viewingDate).valueOf()
).slice(0, 5); // 首页显示最新的5个

const pageTitle = "首页";
const pageDescription = "Pot 的个人博客，记录技术与生活。";
---

<BaseLayout title={pageTitle} description={pageDescription}>
  
  <section class="py-16 md:py-24">
    <div class="max-w-6xl mx-auto px-4">
      <h1 class="text-4xl md:text-6xl font-bold text-center mb-4">
        欢迎来到 <span class="text-primary-500">Pot</span> 的博客
      </h1>
      <p class="text-xl md:text-2xl text-zinc-600 dark:text-zinc-400 text-center max-w-3xl mx-auto">
        {pageDescription}
      </p>
    </div>
  </section>

  <section class="pb-16 md:pb-24">
    <div class="max-w-6xl mx-auto px-4">
      
      <h2 class="text-3xl font-bold mb-8">
        最新文章
      </h2>
      
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 md:gap-8">
        
        {recentPosts.map(post => (
          <PostCard post={post} />
        ))}
        
      </div>

      <div class="text-center mt-12">
        <a 
          href="/blog" 
          class="inline-block bg-primary-500 dark:bg-zinc-800 text-black dark:text-zinc-100 font-bold py-3 px-6 rounded-lg shadow-lg dark:shadow-md transition-all duration-300 hover:bg-primary-600 dark:hover:bg-zinc-700 hover:shadow-xl dark:hover:shadow-zinc-700/50"
        >
          查看所有文章 &rarr;
        </a>
      </div>

    </div>
  </section>

  <section class="pb-16 md:pb-24">
    <div class="max-w-6xl mx-auto px-4">

      <div class="flex justify-between items-center mb-8">
        <h2 class="text-3xl font-bold">
          最近在看
        </h2>
        
        <button
            id="movie-view-toggle"
            aria-label="切换视图"
            class="p-2 rounded-md text-zinc-500 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors"
          >
          <Icon name="tabler:layout-grid" class="w-7 h-7" id="movie-icon-grid" />
          <Icon name="tabler:play-card-q" class="w-7 h-7 hidden" id="movie-icon-deck" />
        </button>
      </div>

      <div id="movie-grid-view" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
        {recentMovies.length > 0 ?
          (
            recentMovies.map(movie => (
              <MovieCard post={movie} />
            ))
          ) : (
            <p class="text-zinc-500 dark:text-zinc-400 col-span-full">
              还没有观影记录，稍后添加...
            </p>
          )}
      </div>

      <div id="movie-deck-view" class="hidden">
        {recentMovies.length > 0 ?
          (
            <div class="movie-deck-wrapper flex justify-center py-8">
               <MovieDeck posts={recentMovies} />
            </div>
          ) : (
             <p class="text-zinc-500 dark:text-zinc-400 text-center py-16">
              还没有观影记录，稍后添加...
            </p>
          )}
      </div>

    </div>
  </section>

  <section class="pb-16 md:pb-24">
    <div class="max-w-6xl mx-auto px-4">
      
      <h2 class="text-3xl font-bold mb-8">
        最近在听
      </h2>

      <div class="max-w-xl mx-auto">
        <MusicPlayer />
      </div>
      
    </div>
  </section>

</BaseLayout>

<script>
  function setupMovieViewToggle() {
    const toggleBtn = document.getElementById('movie-view-toggle');
    const gridView = document.getElementById('movie-grid-view');
    const deckView = document.getElementById('movie-deck-view');
    const gridIcon = document.getElementById('movie-icon-grid');
    const deckIcon = document.getElementById('movie-icon-deck');

    if (!toggleBtn || !gridView || !deckView || !gridIcon || !deckIcon) {
      return;
    }

    // 防止 astro:page-load 重复绑定
    if (toggleBtn.dataset.listenerAttached === 'true') {
      return;
    }
    toggleBtn.dataset.listenerAttached = 'true';

    toggleBtn.addEventListener('click', () => {
      // 切换视图的 hidden 属性
      const isGridNowHidden = gridView.classList.toggle('hidden');
      deckView.classList.toggle('hidden', !isGridNowHidden);

      // 切换按钮图标的 hidden 属性
      gridIcon.classList.toggle('hidden', isGridNowHidden);
      deckIcon.classList.toggle('hidden', !isGridNowHidden);
    });
  }

  // 首次加载时运行
  document.addEventListener('DOMContentLoaded', setupMovieViewToggle);
  // Astro 页面跳转时再次运行
  document.addEventListener('astro:page-load', setupMovieViewToggle);
</script>