---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PostCard from "../components/PostCard.astro";
import MovieCard from "../components/MovieCard.astro";
import RecentMusic from "../components/RecentMusic.astro";
import MovieScroll from "../components/MovieScroll.astro";
import { Icon } from "astro-icon/components";

// 获取博客文章
const allPosts = await getCollection("blog", ({ data }) => {
  return data.draft !== true;
});
const sortedPosts = allPosts.sort(
  (a, b) =>
    new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);
const recentPosts = sortedPosts.slice(0, 5); // 首页显示 5 篇

// 随机文章逻辑
let randomPostUrl = "/blog";
if (allPosts.length > 0) {
  const randomIndex = Math.floor(Math.random() * allPosts.length);
  const randomPost = allPosts[randomIndex];
  const slug = randomPost.id.replace(/\.mdx?$/, "");
  randomPostUrl = `/blog/${slug}/`;
}

// 获取电影
const moviePosts = await getCollection("movie");
const recentMovies = moviePosts
  .sort(
    (a, b) =>
      new Date(b.data.viewingDate).valueOf() -
      new Date(a.data.viewingDate).valueOf()
  )
  .slice(0, 8);

const pageTitle = "首页";
const pageDescription = "Pot's Blog - 思想的流淌与记录";
---

<BaseLayout title={pageTitle} description={pageDescription}>
  {/* --- Hero Section: 极简留白 --- */}
  <section
    class="min-h-[40vh] flex flex-col justify-center items-start py-20 md:py-32"
  >
    <h1
      class="text-6xl md:text-8xl font-serif font-bold text-ink-900 mb-6 tracking-tight"
    >
      Pot's <span class="text-ink-300 italic">Space</span>
    </h1>
    <p
      class="text-xl md:text-2xl text-ink-500 max-w-xl leading-relaxed font-serif"
    >
      做的还不够多，<br />说的还不够少。
    </p>
  </section>

  {/* --- Blog Section: 目录流 --- */}
  <section class="py-16">
    <div
      class="flex items-baseline justify-between mb-12 border-b border-ink-900 pb-4"
    >
      <h2 class="text-sm font-bold tracking-widest uppercase text-ink-900">
        Recent Writings / 最近在写
      </h2>
      <a
        href={randomPostUrl}
        class="text-sm text-ink-500 hover:text-vermilion transition-colors flex items-center gap-1"
      >
        <Icon name="mingcute:random-line" /> 随机漫步
      </a>
    </div>

    <div class="flex flex-col">
      {recentPosts.map((post) => <PostCard post={post} />)}
    </div>

    <div class="mt-12 text-center">
      <a
        href="/blog"
        class="inline-block px-8 py-3 border border-ink-300 text-ink-500 hover:border-vermilion hover:text-vermilion transition-all duration-300 text-sm tracking-widest uppercase"
      >
        View All Archives
      </a>
    </div>
  </section>

  {/* --- Movie Section: 保持原有 Grid 但微调样式 --- */}
  <section class="py-24">
    <div
      class="flex justify-between items-center mb-12 border-b border-ink-900 pb-4"
    >
      <h2 class="text-sm font-bold tracking-widest uppercase text-ink-900">
        Recent Watches / 最近在看
      </h2>

      {/* 视图切换按钮：保持功能，但样式去色 */}
      <button
        id="movie-view-toggle"
        aria-label="切换视图"
        class="text-ink-300 hover:text-vermilion transition-colors"
      >
        <Icon name="tabler:layout-grid" class="w-6 h-6" id="movie-icon-grid" />
        <Icon
          name="tabler:movie"
          class="w-6 h-6 hidden"
          id="movie-icon-scroll"
        />
      </button>
    </div>

    {/* Grid View: 增加间距，去除背景 */}
    <div
      id="movie-grid-view"
      class="grid grid-cols-2 md:grid-cols-4 gap-x-6 gap-y-12 transition-opacity duration-300"
    >
      {
        recentMovies.map((movie) => (
          // 临时覆盖 MovieCard 的样式逻辑，或者后续单独修改 MovieCard
          <div class="group">
            <a
              href={`/movie/${movie.id.replace(/\.mdx?$/, "")}/`}
              class="block overflow-hidden rounded-sm shadow-ink"
            >
              <img
                src={movie.data.coverImage.src}
                alt={movie.data.title}
                class="w-full aspect-2/3 object-cover transition-transform duration-700 group-hover:scale-105 filter grayscale group-hover:grayscale-0"
              />
            </a>
            <h3 class="mt-3 text-lg font-serif font-bold text-ink-900 group-hover:text-vermilion transition-colors">
              {movie.data.title}
            </h3>
            <div class="flex text-yellow-600 text-xs mt-1 gap-1">
              <span>★ {movie.data.rating}</span>
            </div>
          </div>
        ))
      }
    </div>

    {/* Scroll View: 保持不变 */}
    <div
      id="movie-scroll-view"
      class="hidden transition-opacity duration-300 opacity-0"
    >
      <div class="movie-scroll-wrapper flex justify-center py-12">
        <MovieScroll posts={recentMovies} />
      </div>
    </div>
  </section>

  {/* --- Music Section --- */}
  <section class="py-16 border-t border-ink-100">
    <div class="flex items-baseline justify-between mb-12">
      <h2 class="text-sm font-bold tracking-widest uppercase text-ink-900">
        On Repeat / 最近在听
      </h2>
    </div>
    <div class="max-w-2xl">
      <RecentMusic />
    </div>
  </section>
</BaseLayout>

<script>
  function setupMovieViewToggle() {
    const toggleBtn = document.getElementById("movie-view-toggle");
    const gridView = document.getElementById("movie-grid-view");
    const scrollView = document.getElementById("movie-scroll-view");
    const gridIcon = document.getElementById("movie-icon-grid");
    const scrollIcon = document.getElementById("movie-icon-scroll");

    if (!toggleBtn || !gridView || !scrollView || !gridIcon || !scrollIcon)
      return;
    if (toggleBtn.dataset.listenerAttached === "true") return;

    toggleBtn.dataset.listenerAttached = "true";
    const transitionDuration = 300; // 稍微调慢动画

    toggleBtn.addEventListener("click", () => {
      const isGridViewVisible = !gridView.classList.contains("hidden");

      if (isGridViewVisible) {
        // 切换到 Scroll
        gridIcon.classList.add("hidden");
        scrollIcon.classList.remove("hidden");
        gridView.classList.add("opacity-0");

        setTimeout(() => {
          gridView.classList.add("hidden");
          scrollView.classList.remove("hidden");
          // 强制重绘
          void scrollView.offsetWidth;
          scrollView.classList.remove("opacity-0");
          scrollView.classList.add("opacity-100");
        }, transitionDuration);
      } else {
        // 切换到 Grid
        gridIcon.classList.remove("hidden");
        scrollIcon.classList.add("hidden");
        scrollView.classList.remove("opacity-100");
        scrollView.classList.add("opacity-0");

        setTimeout(() => {
          scrollView.classList.add("hidden");
          gridView.classList.remove("hidden");
          void gridView.offsetWidth;
          gridView.classList.remove("opacity-0");
        }, transitionDuration);
      }
    });
  }

  document.addEventListener("DOMContentLoaded", setupMovieViewToggle);
  document.addEventListener("astro:page-load", setupMovieViewToggle);
</script>
