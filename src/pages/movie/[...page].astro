---
// src/pages/movie/[...page].astro

import { getCollection, type CollectionEntry } from "astro:content";
import type { GetStaticPathsOptions, Page } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";
import FormattedDate from "../../components/FormattedDate.astro";

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const moviePosts = await getCollection("movie");
  const sortedMovies = moviePosts.sort(
    (a, b) =>
      new Date(b.data.viewingDate).valueOf() -
      new Date(a.data.viewingDate).valueOf()
  );
  const pageSize = 10;

  return paginate(sortedMovies, { pageSize });
}

const { page } = Astro.props as { page: Page<CollectionEntry<"movie">> };
const pageMovies = page.data;

const currentPage = page.currentPage || 1;
const pageTitle =
  "观影记录" + (currentPage > 1 ? ` (第 ${currentPage} 页)` : "");
const pageDescription = "我看过的所有电影列表。";

function generateStars(rating: number) {
  const totalStars = 5;
  const stars = [];
  for (let i = 1; i <= totalStars; i++) {
    if (rating >= i) stars.push("mingcute:star-fill");
    else if (rating >= i - 0.5) stars.push("mingcute:star-half-fill");
    else stars.push("mingcute:star-line");
  }
  return stars;
}
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <section class="py-16 md:py-24">
    <div class="max-w-6xl mx-auto px-4">
      <h1 class="text-4xl font-bold mb-4">{pageTitle}</h1>
      <p class="text-xl text-zinc-600 dark:text-zinc-400 mb-12">
        {pageDescription}
      </p>

      <ul class="grid">
        {
          pageMovies.map((post) => {
            const slug = post.id.replace(/\.mdx?$/, "");
            const starIcons = generateStars(post.data.rating);
            return (
              <li class="flex flex-col md:flex-row gap-6 md:gap-8 py-12 border-b border-zinc-200 dark:border-zinc-700 first:pt-0 last:pb-0 last:border-b-0">
                <a
                  href={`/movie/${slug}/`}
                  class="w-full max-w-xs mx-auto md:w-1/3 lg:w-1/4 shrink-0 md:max-w-none md:mx-0"
                >
                  {post.data.coverImage && (
                    <Image
                      src={post.data.coverImage}
                      alt={post.data.title}
                      width={400}
                      height={600}
                      format="webp"
                      class="w-full h-auto aspect-2/3 object-cover rounded-lg shadow-lg transition-transform duration-300 hover:scale-105"
                    />
                  )}
                </a>

                <div class="grow flex flex-col">
                  {/* 顶部内容组 */}
                  <div>
                    <a href={`/movie/${slug}/`}>
                      <h2 class="text-3xl font-bold mb-2 text-zinc-900 dark:text-zinc-100 hover:text-primary-500 transition-colors">
                        {post.data.title}
                      </h2>
                    </a>

                    <div class="flex items-center text-yellow-400 mb-3">
                      {starIcons.map((iconName) => (
                        <Icon name={iconName} class="w-5 h-5" />
                      ))}
                      <span class="ml-2 text-lg text-zinc-700 dark:text-zinc-300">
                        {post.data.rating.toFixed(1)}
                      </span>
                    </div>

                    <div class="text-sm text-zinc-500 dark:text-zinc-400 space-y-1 mb-4">
                      <p>
                        <strong>观看于:</strong>{" "}
                        <FormattedDate date={post.data.viewingDate} />
                      </p>
                      {post.data.releaseDate && (
                        <p>
                          <strong>上映于:</strong>{" "}
                          <FormattedDate date={post.data.releaseDate} />
                        </p>
                      )}
                    </div>

                    <p class="text-lg text-zinc-700 dark:text-zinc-300 leading-relaxed">
                      {post.data.shortReview}
                    </p>
                  </div>

                  {/* "弹簧" */}
                  <div class="grow" />

                  {/* 底部内容组 */}
                  <div class="mt-6">
                    {/* 启用 haveReview 判断 */}
                    {post.data.haveReview && (
                      <a
                        href={`/movie/${slug}/`}
                        class="inline-flex items-center gap-1.5 text-sm font-semibold py-2 px-5 rounded-full shadow-md transition-colors duration-200
                        
                        /* Dark/Light 模式配色 */
                        bg-zinc-200 text-zinc-800 hover:bg-zinc-300
                        dark:bg-zinc-700 dark:text-zinc-100 dark:hover:bg-zinc-600
                        
                        /* 移除点击动效 */
                        focus:outline-none 
                        focus-visible:ring-2 focus-visible:ring-zinc-500 focus-visible:ring-offset-2 dark:focus-visible:ring-zinc-400
                      "
                      >
                        <span>阅读长评</span>
                        <Icon name="mingcute:book-2-fill" class="w-4 h-4" />
                      </a>
                    )}
                  </div>
                </div>
              </li>
            );
          })
        }
      </ul>

      {/* 分页导航 */}
      <nav class="flex justify-between items-center mt-16 text-sm">
        {/* 上一页链接 */}
        <div>
          {
            page.url.prev ? (
              <a
                href={page.url.prev}
                class="inline-block py-2 px-4 rounded border border-zinc-300 dark:border-zinc-600 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors"
              >
                &larr; 上一页
              </a>
            ) : (
              <span class="inline-block py-2 px-4 text-zinc-400 dark:text-zinc-600">
                &larr; 上一页
              </span>
            )
          }
        </div>

        {/* 页码指示 */}
        <div class="text-zinc-600 dark:text-zinc-400">
          第 {page.currentPage} / {page.lastPage} 页
        </div>

        {/* 下一页链接 */}
        <div>
          {
            page.url.next ? (
              <a
                href={page.url.next}
                class="inline-block py-2 px-4 rounded border border-zinc-300 dark:border-zinc-600 hover:bg-zinc-100 dark:hover:bg-zinc-800 transition-colors"
              >
                下一页 &rarr;
              </a>
            ) : (
              <span class="inline-block py-2 px-4 text-zinc-400 dark:text-zinc-600">
                下一页 &rarr;
              </span>
            )
          }
        </div>
      </nav>
    </div>
  </section>
</BaseLayout>
