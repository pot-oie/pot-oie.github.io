---
// src/pages/movie/[...page].astro

import { getCollection, type CollectionEntry } from "astro:content";
import type { GetStaticPathsOptions, Page } from "astro";
import BaseLayout from "../../layouts/BaseLayout.astro";
import { Image } from "astro:assets";
import { Icon } from "astro-icon/components";

export async function getStaticPaths({ paginate }: GetStaticPathsOptions) {
  const moviePosts = await getCollection("movie");
  const sortedMovies = moviePosts.sort(
    (a, b) =>
      new Date(b.data.viewingDate).valueOf() -
      new Date(a.data.viewingDate).valueOf()
  );
  const pageSize = 12;
  return paginate(sortedMovies, { pageSize });
}

const { page } = Astro.props as { page: Page<CollectionEntry<"movie">> };
const pageMovies = page.data;
const currentPage = page.currentPage || 1;
const pageTitle = "Cinema Records";
---

<BaseLayout
  title={`Movies - Page ${currentPage}`}
  description="My watched movies collection"
>
  <section class="py-20 md:py-32">
    {/* --- 头部 --- */}
    <div
      class="mb-16 px-4 flex flex-col md:flex-row justify-between items-end border-b border-ink-900 pb-6"
    >
      <div>
        <h1
          class="text-5xl md:text-7xl font-serif font-bold text-ink-900 mb-2 tracking-tight"
        >
          {pageTitle}
        </h1>
        <p class="text-ink-500 font-serif italic text-lg">
          "Fragments of time, captured in light."
        </p>
      </div>

      <div
        class="mt-6 md:mt-0 text-ink-500 font-sans text-sm tracking-widest uppercase"
      >
        Page {page.currentPage}
        <span class="text-ink-300">/</span>
        {page.lastPage}
      </div>
    </div>

    {/* --- 电影网格 (Grid) --- */}
    <div
      class="grid grid-cols-1 min-[340px]:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-8 md:gap-x-6 md:gap-y-12 mb-20"
    >
      {
        pageMovies.map((post) => {
          const slug = post.id.replace(/\.mdx?$/, "");
          return (
            <article class="group flex flex-col gap-3">
              <a
                href={`/movie/${slug}/`}
                class="movie-card-link block overflow-hidden rounded-sm shadow-ink relative aspect-2/3 active:scale-[0.98] transition-transform duration-200"
              >
                {post.data.coverImage && (
                  <Image
                    src={post.data.coverImage}
                    alt={post.data.title}
                    width={600}
                    loading="eager"
                    transition:name={`movie-${slug}`}
                    class="w-full h-full object-cover transition-transform duration-700 md:group-hover:scale-105 filter grayscale contrast-[1.1] md:group-hover:grayscale-0 md:group-hover:contrast-100 active:grayscale-0 active:contrast-100 group-[.is-active]:grayscale-0 group-[.is-active]:contrast-100"
                  />
                )}
                {/* 评分印章 */}
                <div class="absolute top-2 right-2 bg-ink-100/90 backdrop-blur-sm px-2 py-1 text-xs font-serif font-bold text-vermilion rounded-sm shadow-sm transition-all duration-300 opacity-100 translate-y-0 md:opacity-0 md:-translate-y-2.5 md:group-hover:opacity-100 md:group-hover:translate-y-0">
                  {post.data.rating.toFixed(1)}
                </div>
              </a>

              <div class="flex flex-col">
                <h2 class="text-lg font-serif font-bold text-ink-900 md:group-hover:text-vermilion active:text-vermilion group-[.is-active]:text-vermilion transition-colors leading-tight line-clamp-1">
                  <a href={`/movie/${slug}/`}>{post.data.title}</a>
                </h2>
                <p class="text-xs text-ink-500 font-sans tracking-wide mt-1 line-clamp-1 opacity-100 md:opacity-80 md:group-hover:opacity-100 transition-opacity">
                  {post.data.shortReview}
                </p>
              </div>
            </article>
          );
        })
      }
    </div>

    {/* --- 极简分页导航 --- */}
    {
      page.lastPage > 1 && (
        <nav class="flex justify-between items-center border-t border-ink-300/30 pt-8">
          <div class="w-1/3">
            {page.url.prev ? (
              <a
                href={page.url.prev}
                class="inline-flex items-center gap-2 text-ink-900 hover:text-vermilion transition-colors font-serif font-bold group"
              >
                <Icon
                  name="mingcute:arrow-left-line"
                  class="group-hover:-translate-x-1 transition-transform"
                />
                Previous
              </a>
            ) : (
              <div />
            )}
          </div>

          <div class="w-1/3 text-center">
            <span class="text-ink-300 text-sm tracking-widest">●</span>
          </div>

          <div class="w-1/3 flex justify-end">
            {page.url.next ? (
              <a
                href={page.url.next}
                class="inline-flex items-center gap-2 text-ink-900 hover:text-vermilion transition-colors font-serif font-bold group"
              >
                Next
                <Icon
                  name="mingcute:arrow-right-line"
                  class="group-hover:translate-x-1 transition-transform"
                />
              </a>
            ) : (
              <div />
            )}
          </div>
        </nav>
      )
    }
  </section>
</BaseLayout>

<script>
  function setupMovieGridInteractions() {
    const cleanupActiveStates = () => {
      document.querySelectorAll(".is-active").forEach((el) => {
        el.classList.remove("is-active");
      });
    };

    cleanupActiveStates();
    window.addEventListener("pageshow", (event) => {
      if (event.persisted) {
        cleanupActiveStates();
      }
    });

    const links = document.querySelectorAll(".movie-card-link");

    links.forEach((element) => {
      const link = element as HTMLAnchorElement;

      if (link.dataset.bound === "true") return;
      link.dataset.bound = "true";

      link.addEventListener("click", (e) => {
        const mouseEvent = e as MouseEvent;
        const target = e.currentTarget as HTMLAnchorElement;
        const group = target.closest(".group");

        if (
          mouseEvent.metaKey ||
          mouseEvent.ctrlKey ||
          (group && group.classList.contains("is-active"))
        )
          return;

        e.preventDefault();

        if (group) group.classList.add("is-active");

        setTimeout(() => {
          window.location.href = target.href;
        }, 400);
      });
    });
  }

  document.addEventListener("DOMContentLoaded", setupMovieGridInteractions);
  document.addEventListener("astro:page-load", setupMovieGridInteractions);
</script>
